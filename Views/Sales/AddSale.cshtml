@model AddSaleViewModel

@{
    ViewData["Title"] = "Add Sale";
}
<link href="~/css/dist/addsales.css" rel="stylesheet" />
<div style="width:100%;">
    <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
            <h2 class="mb-0 text-center">
                <i class="fa-solid fa-cash-register me-2"></i>
                @if (ViewBag.IsEdit == true)
                {
                    <text>Edit Sale(Sales Return)</text>
                }
                else
                {
                    <text>Add New Sale</text>
                }
            </h2>
        </div>

        <div class="card-body">
            <form asp-action="AddSale" method="post" id="addSaleForm">
                @Html.AntiForgeryToken()
                <!-- Hidden field to track which button was clicked -->
                <input type="hidden" id="actionType" name="actionType" value="" />
                <!-- Hidden field for SaleId when editing -->
                <input type="hidden" asp-for="SaleId" id="saleId" />

                <!-- Product Selection Section -->
                <div class="row mb-4">
                    <div class="col-12">
                        <h5 class="text-primary mb-3">
                            <i class="fa-solid fa-box me-2"></i>Product Selection
                        </h5>
                    </div>
                    <div class="col-md-3">
                        <label for="productSelect" class="form-label">Product:</label>
                        <input id="productSelect" name="ProductId" style="width: 100%;" />
                    </div>
                    <div class="col-md-3">
                        <label for="productSizeSelect" class="form-label">Product Size:</label>
                        <input id="productSizeSelect" name="ProductSizeId" style="width: 100%;" />
                    </div>
                    <div class="col-md-3">
                        <label for="quantity" class="form-label">Quantity:</label>
                        <input type="number" id="quantity" class="form-control" value="1" min="0.01" step="0.01" />
                    </div>
                    <div class="col-md-3">
                        <label for="unitPrice" class="form-label">Unit Price:</label>
                        <input type="number" id="unitPrice" class="form-control" value="0" step="0.01" readonly />
                    </div>
                    <div class="col-md-3">
                        <label for="salePrice" class="form-label">Sale Price:</label>
                        <input type="number" id="salePrice" class="form-control" value="0" step="0.01" />
                    </div>
                </div>

                <div class="row mb-4">
                    <div class="col-md-3">
                        <label for="discountAmount" class="form-label">Line Discount:</label>
                        <input type="number" id="discountAmount" class="form-control" value="0" step="0.01" />
                    </div>
              
                    <div class="col-md-3">
                        <label for="payableAmount" class="form-label">Payable Amount:</label>
                        <input type="number" id="payableAmount" class="form-control" value="0" step="0.01" readonly />
                    </div>
                    <div class="col-md-6 d-flex align-items-end">
                        <button type="button" class="btn btn-primary me-2" id="addToTable" title="Add product to sale (Ctrl+Enter)">
                            <i class="fa-solid fa-plus me-1"></i>Add to Sale
                        </button>
                        <button type="button" class="btn btn-outline-secondary" id="resetFields" title="Reset product fields (Escape)">
                            <i class="fa-solid fa-rotate-left me-1"></i>Reset Product
                        </button>
                    </div>
                </div>

                <!-- Sale Items Table -->
                <div class="row mb-4">
                    <div class="col-12">
                        <h5 class="text-primary mb-3">
                            <i class="fa-solid fa-list me-2"></i>Sale Items
                        </h5>
                        <div class="table-responsive">
                            <table class="table table-striped table-hover" id="saleDetailsTable">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Measuring Unit</th>
                                        <th>Product</th>
                                        <th>Item Level Discount</th>
                                        <th>Unit Sale Price</th>
                                        <th>Qty</th>
                                        <th>Total Discount</th>
                                        <th>Payable</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody id="saleDetailsBody">
                                    <!-- Product rows will be added via JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Sale Information Section -->
                <div class="row mb-4">
                    <div class="col-12">
                        <h5 class="text-primary mb-3">
                            <i class="fa-solid fa-user me-2"></i>Sale Information
                        </h5>
                    </div>
                    <div class="col-md-3">
                        <label asp-for="CustomerId" class="form-label">Customer:</label>
                        <input asp-for="CustomerId" id="customerSelect" style="width: 100%;" />
                        <span asp-validation-for="CustomerId" class="text-danger"></span>
                    </div>
                    <div class="col-md-3">
                        <label asp-for="VendorId" class="form-label">Vendor:</label>
                        <input asp-for="VendorId" id="vendorSelect" style="width: 100%;" />
                        <span asp-validation-for="VendorId" class="text-danger"></span>
                        <small class="form-text text-muted">Select either customer or vendor</small>
                    </div>
                    <div class="col-md-3">
                        <label asp-for="BillNo" class="form-label">Bill #:</label>
                        @if (ViewBag.IsEdit == true)
                        {
                            <input asp-for="BillNo" class="form-control" readonly />
                        }
                        else
                        {
                            <input asp-for="BillNo" class="form-control" value="@ViewBag.NextBillNumber" readonly />
                        }
                    </div>
                    <div class="col-md-3">
                        <label asp-for="SaleDate" class="form-label">Sale Date:</label>
                        <input type="date" asp-for="SaleDate" class="form-control" value="@DateTime.Now.ToString("yyyy-MM-dd")" />
                    </div>
                    <div class="col-md-3">
                        <label asp-for="PayNow" class="form-label">Pay Now (Optional):</label>
                        <input asp-for="PayNow" class="form-control" value="0" step="0.01" placeholder="Enter payment amount (optional)" />
                        <small class="form-text text-muted">Leave empty to add full amount to customer's due</small>
                    </div>
                   </div>
                   <div class="row">
                    <div class="col-md-3">
                        <label asp-for="TotalAmount" class="form-label">Total Amount:</label>
                        <input asp-for="TotalAmount" class="form-control" value="0" readonly />
                    </div>
                    <div class="col-md-3">
                        <label asp-for="DiscountAmount" class="form-label">Total Discount:</label>
                        <input asp-for="DiscountAmount" class="form-control" value="0" step="0.01" />
                    </div>
                    <div class="col-md-3">
                        <label asp-for="ReceivedAmount" class="form-label">Received Amount:</label>
                        <input asp-for="ReceivedAmount" class="form-control" value="0" step="0.01" readonly />
                    </div>
                    <div class="col-md-3">
                        <label asp-for="DueAmount" class="form-label">Due Amount:</label>
                        <input asp-for="DueAmount" class="form-control" value="0" readonly />
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-3">
                        <label class="form-label">Payment Method:</label>
                        <input asp-for="PaymentMethod" id="paymentMethodSelect" style="width: 100%;" />
                        <span asp-validation-for="PaymentMethod" class="text-danger"></span>
                    </div>
                    <div class="col-md-3" id="onlineAccountDiv" style="display: none;">
                        <label class="form-label">Online Account:</label>
                        <input asp-for="OnlineAccountId" id="onlineAccountSelect" style="width: 100%;" />
                        <span asp-validation-for="OnlineAccountId" class="text-danger"></span>
                    </div>
                    <div class="col-md-6">
                        <label asp-for="PreviousDue" class="form-label">Previous Due:</label>
                        <div class="input-group">
                            <input asp-for="PreviousDue" class="form-control" value="0" step="0.01" readonly />
                            <span class="input-group-text">
                                <i class="fa-solid fa-rupee-sign"></i>
                            </span>
                        </div>
                        <small class="form-text text-muted">This will be populated automatically when you select a customer</small>
                    </div>
                    <div class="col-md-6">
                        <label asp-for="Description" class="form-label">Description:</label>
                        <textarea asp-for="Description" class="form-control" rows="3" placeholder="Enter sale description..."></textarea>
                    </div>
                </div>

             

                <!-- Action Buttons -->
                <div class="row">
                    <div class="col-12 text-center">
                        <button type="button" class="btn btn-success me-2" onclick="saveAndPrintSale()">
                            <i class="fa-solid fa-print me-1"></i>
                            @if (ViewBag.IsEdit == true)
                            {
                                <text>Update and Print</text>
                            }
                            else
                            {
                                <text>Save and Print</text>
                            }
                        </button>
                        <button type="button" class="btn btn-primary me-2" onclick="saveSale()">
                            <i class="fa-solid fa-save me-1"></i>
                            @if (ViewBag.IsEdit == true)
                            {
                                <text>Update Sale</text>
                            }
                            else
                            {
                                <text>Save Sale</text>
                            }
                        </button>
                        <a asp-action="Index" class="btn btn-secondary">
                            <i class="fa-solid fa-arrow-left me-1"></i>Back to Sales
                        </a>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    @* <script src="~/js/sales-form-service.js"></script> *@

    <script>
        let rowIndex = 0;
        let selectedProductSize = null;
        let currentAvailableStock = 0;
        let baseUnitId = null; // The base unit for the product (from product size)

        // Initialize on page load
        $(document).ready(function() {
            console.log("=== ADD SALE PAGE LOADED ===");
            console.log("jQuery version:", $.fn.jquery);
            console.log("Kendo available:", typeof kendo !== 'undefined');
            console.log("Kendo ComboBox available:", typeof $.fn.kendoComboBox !== 'undefined');
            
            // Wait a bit for all scripts to load
            setTimeout(function() {
                console.log("=== INITIALIZING KENDO UI DROPDOWNS ===");
                // Initialize Kendo UI dropdowns
                initializeKendoDropdowns();
                
                // Setup additional functions
                setupFallbackEvents();
                setupTestFunctions();
                setupAdditionalTestFunctions();
                setupToggleOnlineAccountDiv();
                
                // Initialize edit mode if we're editing (with a small delay to ensure Kendo dropdowns are ready)
                @if (ViewBag.IsEdit == true)
                {
                    <text>
                    setTimeout(function() {
                        initializeEditMode();
                    }, 200);
                    </text>
                }
                
                // Set up event listeners
                setupEventListeners();
            }, 100);

            // Check if we're editing an existing sale
            const isEdit = @(ViewBag.IsEdit?.ToString().ToLower() ?? "false")
            console.log('Is edit mode:', isEdit);
            if (isEdit) {
                populateExistingSaleDetails();
            }
        });

        // Initialize form for edit mode

        function initializeEditMode() {
            debugger;
            console.log('=== INITIALIZING EDIT MODE ===');
            
            // Get model values safely
            const saleId = @(Model.SaleId?.ToString() ?? "null");
            const customerId = '@(Model.CustomerId?.ToString() ?? "null")';
            const vendorId = '@(Model.VendorId?.ToString() ?? "null")';
            const paymentMethod = @(Model.PaymentMethod != null ? Html.Raw($"\"{Model.PaymentMethod}\"") : "null");
            const onlineAccountId = @(Model.OnlineAccountId?.ToString() ?? "null")
            
            console.log('Model values:', { saleId, customerId, vendorId, paymentMethod, onlineAccountId });
            
            // Set SaleId in hidden field
            if (saleId && saleId !== "null") {
                $('#saleId').val(saleId.toString());
                console.log('SaleId set to:', saleId);
            }
            
            // Set vendor or customer dropdown value
            const vendorComboForEdit = $("#vendorSelect").data("kendoComboBox");
            const customerCombo = $("#customerSelect").data("kendoComboBox");
            if (vendorComboForEdit && vendorId && vendorId !== "null") {
                vendorComboForEdit.value(vendorId.toString());
                if (customerCombo) {
                    customerCombo.value('');
                    customerCombo.text('');
                }
                console.log('Vendor set to:', vendorId);
                setPreviousDueForVendor();
            } else if (customerCombo && customerId && customerId !== "null") {
                customerCombo.value(customerId.toString());
                console.log('Customer set to:', customerId);
                
                // Load previous due amount for the selected customer
                loadPreviousDueAmount();
            }
            
            // Set payment method dropdown value
            const paymentMethodCombo = $("#paymentMethodSelect").data("kendoComboBox");
            if (!paymentMethodCombo) {
                console.error('Payment method combo not found! Retrying in 100ms...');
                setTimeout(function() {
                    initializeEditMode();
                }, 100);
                return;
            }
            
            if (paymentMethod && paymentMethod !== "null") {
                // Remove quotes if present (from JSON serialization)
                const cleanPaymentMethod = typeof paymentMethod === 'string' ? paymentMethod.replace(/^"|"$/g, '') : paymentMethod;
                
                // Verify the value exists in the data source
                const dataSource = paymentMethodCombo.dataSource.data();
                const validValue = dataSource.find(item => item.value === cleanPaymentMethod);
                
                if (validValue) {
                    paymentMethodCombo.value(cleanPaymentMethod);
                    console.log('Payment method set to:', cleanPaymentMethod);
                } else {
                    console.warn('Payment method value not found in data source:', cleanPaymentMethod);
                    console.log('Available payment methods:', dataSource);
                }
                
                // Show/hide online account dropdown based on payment method
                if (cleanPaymentMethod === "Online") {
                    $("#onlineAccountDiv").show();
                    const onlineAccountCombo = $("#onlineAccountSelect").data("kendoComboBox");
                    if (onlineAccountCombo) {
                        onlineAccountCombo.enable(true);
                        // Load online accounts if not already loaded
                        if (onlineAccountCombo.dataSource.data().length === 0) {
                            console.log("Loading online accounts for edit mode...");
                            // Load accounts and then set the value
                            fetch("/Sales/GetOnlineAccounts")
                                .then(response => response.json())
                                .then(data => {
                                    console.log("Online accounts loaded:", data);
                                    if (data && data.length > 0) {
                                        onlineAccountCombo.dataSource.data(data);
                                        onlineAccountCombo.enable(true);
                                        onlineAccountCombo.refresh();
                                        
                                        // Set the value after accounts are loaded
                                        if (onlineAccountId && onlineAccountId !== "null" && onlineAccountId !== null) {
                                            onlineAccountCombo.value(onlineAccountId.toString());
                                            console.log('Online Account ID set to:', onlineAccountId);
                                        }
                                    }
                                })
                                .catch(error => {
                                    console.error("Error loading online accounts:", error);
                                });
                        } else {
                            // Accounts already loaded, just set the value
                            if (onlineAccountId && onlineAccountId !== "null" && onlineAccountId !== null) {
                                onlineAccountCombo.value(onlineAccountId.toString());
                                console.log('Online Account ID set to:', onlineAccountId);
                            }
                        }
                    }
                } else {
                    console.log('Payment method is null or not set');
                    console.log('PaymentMethod value:', paymentMethod);
                }
            } else {
                console.log('Payment method is null or not set');
                console.log('PaymentMethod value:', paymentMethod);
            }
            
            console.log('=== EDIT MODE INITIALIZATION COMPLETE ===');
        }

        // Initialize Kendo UI ComboBoxes
        function initializeKendoDropdowns() {
            console.log("=== INITIALIZING KENDO UI DROPDOWNS ===");
            console.log("jQuery available:", typeof $ !== 'undefined');
            console.log("Kendo available:", typeof kendo !== 'undefined');
            console.log("Kendo ComboBox available:", typeof $.fn.kendoComboBox !== 'undefined');
            
            try {
            // Product Selection Combobox
            $("#productSelect").kendoComboBox({
                dataSource: {
                    transport: {
                        read: {
                            url: "/Sales/GetProducts",
                            dataType: "json"
                        }
                    }
                },
                dataTextField: "text",
                dataValueField: "value",
                placeholder: "-- Select Product --",
                filter: "contains",
                suggest: true,
                minLength: 1,
                change: function(e) {
                    console.log("=== PRODUCT CHANGE EVENT TRIGGERED ===");
                    console.log("Product selection changed:", e.sender.value());
                    console.log("Product change event - calling loadProductSizes");
                    console.log("Event object:", e);
                    loadProductSizes();
                },
                select: function(e) {
                    console.log("Product selected:", e.item);
                    console.log("Product select event - calling loadProductSizes");
                    loadProductSizes();
                }
            });

            // Product Size Selection Combobox
            $("#productSizeSelect").kendoComboBox({
                dataSource: {
                    data: []
                },
                dataTextField: "text",
                dataValueField: "value",
                placeholder: "-- Select Size --",
                filter: "contains",
                suggest: true,
                minLength: 1,
                enabled: false,
                readonly: false,
                change: function(e) {
                    console.log("Product size change event triggered");
                    onProductSizeChange();
                },
                select: function(e) {
                    console.log("Product size select event triggered");
                    onProductSizeChange();
                }
            });

            // Unit dropdown removed - using product size unit directly

            let suppressPartyChange = false;

            // Customer Selection Combobox
            $("#customerSelect").kendoComboBox({
                dataSource: {
                    transport: {
                        read: {
                            url: "/Sales/GetCustomers",
                            dataType: "json"
                        }
                    }
                },
                dataTextField: "text",
                dataValueField: "value",
                placeholder: "-- Select Customer --",
                filter: "contains",
                suggest: true,
                minLength: 1,
                change: function() {
                    if (suppressPartyChange) return;
                    const customerValue = this.value();
                    if (customerValue) {
                        suppressPartyChange = true;
                        const vendorComboForCustomer = $("#vendorSelect").data("kendoComboBox");
                        if (vendorComboForCustomer) {
                            vendorComboForCustomer.value('');
                            vendorComboForCustomer.text('');
                        }
                        suppressPartyChange = false;
                    }
                    loadPreviousDueAmount();
                }
            });

            // Vendor Selection Combobox
            $("#vendorSelect").kendoComboBox({
                dataSource: {
                    transport: {
                        read: {
                            url: "/Sales/GetVendors",
                            dataType: "json"
                        }
                    }
                },
                dataTextField: "text",
                dataValueField: "value",
                placeholder: "-- Select Vendor --",
                filter: "contains",
                suggest: true,
                minLength: 1,
                change: function() {
                    if (suppressPartyChange) return;
                    const vendorValue = this.value();
                    if (vendorValue) {
                        suppressPartyChange = true;
                        const customerCombo = $("#customerSelect").data("kendoComboBox");
                        if (customerCombo) {
                            customerCombo.value('');
                            customerCombo.text('');
                        }
                        suppressPartyChange = false;
                        setPreviousDueForVendor();
                    } else {
                        loadPreviousDueAmount();
                    }
                }
            });

            // Payment Method Combobox
            $("#paymentMethodSelect").kendoComboBox({
                dataSource: {
                    data: [
                        { value: "Cash", text: "Cash" },
                        { value: "Online", text: "Online" },
                        { value: "Pay Later", text: "Pay Later" }
                    ]
                },
                dataTextField: "text",
                dataValueField: "value",
                placeholder: "-- Select Payment Method --",
                filter: "contains",
                suggest: true,
                minLength: 1,
                change: function() {
                    toggleOnlineAccountDiv();
                }
            });

            // Online Account Selection Combobox
            $("#onlineAccountSelect").kendoComboBox({
                dataSource: {
                    data: []
                },
                dataTextField: "text",
                dataValueField: "value",
                placeholder: "-- Select Online Account --",
                filter: "contains",
                suggest: true,
                minLength: 1,
                enabled: false
            });

            console.log("Kendo UI dropdowns initialized successfully for Sales AddSale");
            
            } catch (error) {
                console.error("Error initializing Kendo UI dropdowns:", error);
            }
            }
            
            // Additional fallback event binding
        function setupFallbackEvents() {
            setTimeout(function() {
                const productCombo = $("#productSelect").data("kendoComboBox");
                if (productCombo) {
                    productCombo.bind("change", function(e) {
                        console.log("Fallback product change event triggered");
                        console.log("Fallback - calling loadProductSizes");
                        loadProductSizes();
                    });
                    productCombo.bind("select", function(e) {
                        console.log("Fallback product select event triggered");
                        console.log("Fallback select - calling loadProductSizes");
                        loadProductSizes();
                    });
                }
            }, 200);
        }
            
        // Setup test functions
        function setupTestFunctions() {
            // Make functions globally available for testing
            window.testLoadProductSizes = loadProductSizes;
            window.testGetProductCombo = function() {
                return $("#productSelect").data("kendoComboBox");
            };
            window.testProductChange = function() {
                console.log("Manual test - triggering product change");
                loadProductSizes();
            };
            window.testGetProductValue = function() {
                const productCombo = $("#productSelect").data("kendoComboBox");
                return productCombo ? productCombo.value() : null;
            };
            window.testTriggerProductChange = function() {
                const productCombo = $("#productSelect").data("kendoComboBox");
                if (productCombo) {
                    console.log("Manually triggering product change event");
                    productCombo.trigger("change");
                } else {
                    console.log("Product combobox not found");
                }
            };
        }

        // Setup additional test functions
        function setupAdditionalTestFunctions() {
            window.testGetProductSizes = function(productId) {
                console.log("Testing GetProductSizes endpoint with productId:", productId);
                fetch(`/Sales/GetProductSizes?productId=${productId}`)
                    .then(response => {
                        console.log("Response status:", response.status);
                        console.log("Response ok:", response.ok);
                        return response.json();
                    })
                    .then(data => {
                        console.log("Raw response data:", data);
                        console.log("Data length:", data ? data.length : 0);
                    })
                    .catch(error => {
                        console.error("Error testing GetProductSizes:", error);
                    });
            };
            
            // Test function to manually trigger product change
            window.testProductChange = function() {
                console.log("=== MANUAL PRODUCT CHANGE TEST ===");
                const productCombo = $("#productSelect").data("kendoComboBox");
                if (productCombo) {
                    const currentValue = productCombo.value();
                    console.log("Current product value:", currentValue);
                    if (currentValue) {
                        console.log("Manually calling loadProductSizes with current value");
                        loadProductSizes();
                    } else {
                        console.log("No product selected - please select a product first");
                    }
                } else {
                    console.log("Product combobox not found");
                }
            };
            
            // Test function to directly test the AJAX endpoint
            window.testDirectAjax = function(productId) {
                console.log("=== DIRECT AJAX TEST ===");
                console.log("Testing direct AJAX call to GetProductSizes with productId:", productId);
                fetch(`/Sales/GetProductSizes?productId=${productId}`)
                    .then(response => {
                        console.log("Direct test - Response status:", response.status);
                        console.log("Direct test - Response ok:", response.ok);
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log("Direct test - Response data:", data);
                        console.log("Direct test - Data length:", data ? data.length : 0);
                        console.log("Direct test - Data type:", typeof data);
                        console.log("Direct test - Is array:", Array.isArray(data));
                    })
                    .catch(error => {
                        console.error("Direct test - Error:", error);
                    });
            };
            
            // Test function to check if product has any sizes in database
            window.testProductSizes = function() {
                console.log("=== TESTING PRODUCT SIZES ===");
                const productCombo = $("#productSelect").data("kendoComboBox");
                if (productCombo) {
                    const productId = productCombo.value();
                    if (productId) {
                        console.log("Testing with current product ID:", productId);
                        window.testDirectAjax(productId);
                    } else {
                        console.log("No product selected - please select a product first");
                    }
                } else {
                    console.log("Product combobox not found");
                }
            };
        }
            
            // Function to toggle online account dropdown visibility and load data
        function setupToggleOnlineAccountDiv() {
            window.toggleOnlineAccountDiv = function() {
                const paymentMethodCombo = $("#paymentMethodSelect").data("kendoComboBox");
                const onlineAccountCombo = $("#onlineAccountSelect").data("kendoComboBox");
                const onlineAccountDiv = $("#onlineAccountDiv");
                
                if (paymentMethodCombo && onlineAccountCombo) {
                    const selectedPaymentMethod = paymentMethodCombo.value();
                    console.log("Payment method changed to:", selectedPaymentMethod);
                    
                    if (selectedPaymentMethod === "Online") {
                        console.log("Payment method is Online - showing online account dropdown");
                        onlineAccountDiv.show();
                        onlineAccountCombo.enable(true);
                        
                        // Load online accounts if not already loaded
                        if (onlineAccountCombo.dataSource.data().length === 0) {
                            console.log("Loading online accounts...");
                            loadOnlineAccounts();
                        }
                    } else {
                        console.log("Payment method is not Online - hiding online account dropdown");
                        onlineAccountDiv.hide();
                        onlineAccountCombo.enable(false);
                        onlineAccountCombo.value("");
                    }
                }
            };
            
            // Function to load online accounts
            window.loadOnlineAccounts = function() {
                const onlineAccountCombo = $("#onlineAccountSelect").data("kendoComboBox");
                if (onlineAccountCombo) {
                    console.log("Loading online accounts from server...");
                    fetch("/Sales/GetOnlineAccounts")
                        .then(response => {
                            console.log("Online accounts response status:", response.status);
                            if (!response.ok) {
                                throw new Error(`HTTP error! status: ${response.status}`);
                            }
                            return response.json();
                        })
                        .then(data => {
                            console.log("Online accounts data received:", data);
                            if (data && data.length > 0) {
                                onlineAccountCombo.dataSource.data(data);
                                onlineAccountCombo.enable(true);
                                onlineAccountCombo.refresh();
                                console.log("Online accounts loaded successfully");
                            } else {
                                console.log("No online accounts found");
                                onlineAccountCombo.dataSource.data([]);
                                onlineAccountCombo.enable(false);
                            }
                        })
                        .catch(error => {
                            console.error("Error loading online accounts:", error);
                            onlineAccountCombo.dataSource.data([]);
                            onlineAccountCombo.enable(false);
                        });
                }
            };
        }

        function setupEventListeners() {
            // Note: Kendo UI combobox change events are handled in the initialization above
            // These event listeners are kept for compatibility but may not be needed

            // Quantity, sale price, discount change
            document.getElementById('quantity').addEventListener('input', function() {
                calculatePayableAmount();
                validateQuantityInput();
            });
            document.getElementById('salePrice').addEventListener('input', calculatePayableAmount);
            document.getElementById('discountAmount').addEventListener('input', calculatePayableAmount);

            // Add to table button
            document.getElementById('addToTable').addEventListener('click', addProductToTable);

            // Reset fields button
            document.getElementById('resetFields').addEventListener('click', resetFields);

            // Reset all fields button


            // Old event listeners removed - now using onclick methods with AJAX

            // Form submission event listener - just for logging
            document.getElementById('addSaleForm').addEventListener('submit', function(e) {
                console.log('=== FORM SUBMIT EVENT TRIGGERED ===');
                console.log('Form action:', this.action);
                console.log('Form method:', this.method);

                // Log form data for debugging
                const formData = new FormData(this);
                console.log('=== FORM DATA BEING SUBMITTED ===');
                for (let [key, value] of formData.entries()) {
                    console.log(`${key}: ${value}`);
                }

                // Show loading state
                showLoadingState();
            });

            // Remove row functionality - using event delegation for dynamically added rows
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('remove-row') || e.target.closest('.remove-row')) {
                    const row = e.target.closest('tr');
                    if (row) {
                        // Get the base unit quantity from hidden field before removing
                        const quantityInput = row.querySelector('input[name*=".Quantity"]');
                        const baseUnitQuantity = quantityInput ? parseFloat(quantityInput.value) || 0 : 0;
                        const productIdInput = row.querySelector('input[name*=".ProductId"]');
                        const productId = productIdInput ? productIdInput.value : null;
                        const productRangeIdInput = row.querySelector('input[name*=".ProductRangeId"]');
                        const productRangeId = productRangeIdInput ? productRangeIdInput.value : null;
                        
                        // Remove the row
                        row.remove();
                        
                        // Restore stock if we have the necessary information
                        if (productId && baseUnitQuantity > 0) {
                            restoreStockAfterRemove(productId, productRangeId, baseUnitQuantity);
                        }
                        
                        updateTotals();
                        showSuccessMessage('Product removed from sale successfully!');
                    }
                }

                // Edit row functionality
                if (e.target.classList.contains('edit-row') || e.target.closest('.edit-row')) {
                    const row = e.target.closest('tr');
                    if (row) {
                        editProductFromTable(row);
                    }
                }
            });

            // Total calculation inputs
            document.getElementById('DiscountAmount').addEventListener('input', updateTotals);
            document.getElementById('ReceivedAmount').addEventListener('input', updateReceivedAmountFromReceived);
            document.getElementById('PayNow').addEventListener('input', updateReceivedAmount);
            document.getElementById('PreviousDue').addEventListener('input', updateTotals);

            // Additional event listeners for real-time updates
            document.getElementById('TotalAmount').addEventListener('input', updateTotals);
            document.getElementById('DueAmount').addEventListener('input', updateTotals);

            // Initialize display on page load
            updateAmountDisplay();

            // Add keyboard shortcuts
            document.addEventListener('keydown', function(e) {
                // Ctrl+Enter to add product to table
                if (e.ctrlKey && e.key === 'Enter') {
                    e.preventDefault();
                    addProductToTable();
                }

                // Escape to reset fields
                if (e.key === 'Escape') {
                    e.preventDefault();
                    resetFields();
                }
            });
        }

        function loadProductSizes() {
            console.log("=== loadProductSizes function called ===");
            const productCombo = $("#productSelect").data("kendoComboBox");
            const productId = productCombo ? productCombo.value() : null;
            const sizeCombo = $("#productSizeSelect").data("kendoComboBox");

            console.log("Product ID:", productId);
            console.log("Product Combo exists:", !!productCombo);
            console.log("Size Combo exists:", !!sizeCombo);
            
            if (!productId) {
                console.log("No product ID - cannot load product sizes");
                return;
            }

            // Clear and disable size combobox
            if (sizeCombo) {
                sizeCombo.value("");
                sizeCombo.enable(false);
                sizeCombo.dataSource.data([]);
            }

            // Reset fields
            resetProductFields();

            if (productId) {
                console.log("Loading product sizes for product ID:", productId);

                // Load available stock first
                loadAvailableStock(productId);

                // AJAX call to fetch product sizes
                console.log("Making AJAX call to:", `/Sales/GetProductSizes?productId=${productId}`);
                fetch(`/Sales/GetProductSizes?productId=${productId}`)
                    .then(response => {
                        console.log("Product sizes response status:", response.status);
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log("Product sizes data received:", data);
                        console.log("Data length:", data ? data.length : 0);
                        console.log("Data type:", typeof data);
                        console.log("Is array:", Array.isArray(data));
                        
                        if (data && data.length > 0) {
                            console.log("Processing product sizes data...");
                            // Log each item for debugging
                            data.forEach((item, index) => {
                                console.log(`Item ${index}:`, item);
                            });
                            
                            if (sizeCombo) {
                                console.log("Updating Kendo combobox with data...");
                                // Update Kendo combobox with new data
                                sizeCombo.dataSource.data(data);
                                sizeCombo.enable(true);
                                sizeCombo.readonly(false);
                                sizeCombo.refresh();
                                console.log("Product sizes loaded successfully");
                                console.log("Product size combobox enabled and not readonly");
                                
                                // Additional fallback to ensure combobox is properly enabled
                                setTimeout(() => {
                                    if (sizeCombo) {
                                        sizeCombo.enable(true);
                                        sizeCombo.readonly(false);
                                        console.log("Fallback: Product size combobox re-enabled");
                                    }
                                }, 100);
                            } else {
                                console.log("Size combobox not available for data update");
                            }
                        } else {
                            console.log("No product sizes found - data is empty or null");
                            console.log("Data details:", {
                                data: data,
                                isNull: data === null,
                                isUndefined: data === undefined,
                                length: data ? data.length : 'N/A'
                            });
                            if (sizeCombo) {
                                sizeCombo.dataSource.data([]);
                                sizeCombo.enable(false);
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Error loading product sizes:', error);
                        if (sizeCombo) {
                            sizeCombo.dataSource.data([]);
                            sizeCombo.enable(false);
                        }
                    });
            } else {
                console.log("No product ID provided");
            }
        }

        function loadAvailableStock(productId) {
            fetch(`/Sales/GetAvailableStock?productId=${productId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        currentAvailableStock = data.availableQuantity;
                        updateStockDisplay();
                        console.log('Available stock loaded:', currentAvailableStock);
                    } else {
                        currentAvailableStock = 0;
                        updateStockDisplay();
                        console.error('Error loading stock:', data.message);
                    }
                })
                .catch(error => {
                    console.error('Error loading available stock:', error);
                    currentAvailableStock = 0;
                    updateStockDisplay();
                });
        }

        function updateStockDisplay() {
            const quantityInput = document.getElementById('quantity');
            // Use full decimal value for display, but allow decimal input
            const maxQuantity = currentAvailableStock;

            // Update max attribute with full decimal value
            quantityInput.setAttribute('max', maxQuantity);

            // Update placeholder to show available stock with full precision
            quantityInput.setAttribute('placeholder', `Max: ${maxQuantity.toFixed(3)}`);

            // Get unit name from selected product size
            let unitName = '';
            if (selectedProductSize && selectedProductSize.measuringUnitName) {
                unitName = selectedProductSize.measuringUnitName;
            } else if (selectedProductSize && selectedProductSize.measuringUnitAbbreviation) {
                unitName = selectedProductSize.measuringUnitAbbreviation;
            }

            // Add visual indicator with unit name - show full decimal value
            const quantityLabel = document.querySelector('label[for="quantity"]');
            if (quantityLabel) {
                if (unitName) {
                    quantityLabel.innerHTML = `Quantity (${unitName}): <small class="text-muted">(Available: ${maxQuantity.toFixed(3)} ${unitName})</small>`;
                } else {
                    quantityLabel.innerHTML = `Quantity: <small class="text-muted">(Available: ${maxQuantity.toFixed(3)})</small>`;
                }
            }
        }

        function validateQuantityInput() {
            const quantityInput = document.getElementById('quantity');
            const quantity = parseFloat(quantityInput.value) || 0;
            const maxQuantity = currentAvailableStock; // Use full decimal value

            // Remove previous validation styling
            quantityInput.classList.remove('is-invalid', 'is-valid');

            if (quantity > 0 && currentAvailableStock > 0) {
                if (quantity > maxQuantity) {
                    // Show error styling
                    quantityInput.classList.add('is-invalid');
                    quantityInput.setCustomValidity(`Maximum quantity allowed: ${maxQuantity.toFixed(3)}`);
                } else {
                    // Show valid styling
                    quantityInput.classList.add('is-valid');
                    quantityInput.setCustomValidity('');
                }
            } else if (quantity > 0 && currentAvailableStock === 0) {
                quantityInput.classList.add('is-invalid');
                quantityInput.setCustomValidity('No stock available for this product');
            } else {
                quantityInput.setCustomValidity('');
            }
        }

        function loadPreviousDueAmount() {
            const customerCombo = $("#customerSelect").data("kendoComboBox");
            const customerId = customerCombo ? customerCombo.value() : null;
            const vendorComboForDue = $("#vendorSelect").data("kendoComboBox");
            const vendorId = vendorComboForDue ? vendorComboForDue.value() : null;
            const previousDueInput = document.getElementById('PreviousDue');

            if (vendorId) {
                setPreviousDueForVendor();
                return;
            }

            if (customerId) {
                // Show loading state
                previousDueInput.value = 'Loading...';
                previousDueInput.style.backgroundColor = '#f8f9fa';
                previousDueInput.style.color = '#6c757d';

                // AJAX call to fetch previous due amount
                fetch(`/Sales/GetPreviousDueAmount?customerId=${customerId}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            const amount = parseFloat(data.previousDueAmount);
                            previousDueInput.value = amount.toFixed(2);

                            // Visual feedback based on amount
                            if (amount > 0) {
                                previousDueInput.style.backgroundColor = '#fff3cd';
                                previousDueInput.style.color = '#856404';
                                showSuccessMessage(`Previous due amount loaded: Rs${amount.toFixed(2)}`);
                            } else {
                                previousDueInput.style.backgroundColor = '#d1edff';
                                previousDueInput.style.color = '#0c5460';
                                showSuccessMessage('No previous due amount for this customer');
                            }
                        } else {
                            previousDueInput.value = '0.00';
                            previousDueInput.style.backgroundColor = '#f8d7da';
                            previousDueInput.style.color = '#721c24';
                            showErrorMessage(data.message || 'Error loading previous due amount');
                        }
                    })
                    .catch(error => {
                        console.error('Error loading previous due amount:', error);
                        previousDueInput.value = '0.00';
                        previousDueInput.style.backgroundColor = '#f8d7da';
                        previousDueInput.style.color = '#721c24';
                        showErrorMessage('Error loading previous due amount');
                    })
                    .finally(() => {
                        // Reset to normal state after a delay
                        setTimeout(() => {
                            previousDueInput.style.backgroundColor = '';
                            previousDueInput.style.color = '';
                        }, 2000);

                        // Update totals after loading previous due
                        updateTotals();
                    });
            } else {
                // Clear previous due when no customer selected
                previousDueInput.value = '0.00';
                previousDueInput.style.backgroundColor = '';
                previousDueInput.style.color = '';
                updateTotals();
            }
        }

        function setPreviousDueForVendor() {
            const previousDueInput = document.getElementById('PreviousDue');
            previousDueInput.value = '0.00';
            previousDueInput.style.backgroundColor = '#e2e3e5';
            previousDueInput.style.color = '#41464b';
            showSuccessMessage('Vendor selected. Previous due is not tracked.');
        }

        function onProductSizeChange() {
            console.log("onProductSizeChange function called");
            const sizeCombo = $("#productSizeSelect").data("kendoComboBox");
            const selectedValue = sizeCombo ? sizeCombo.value() : null;
            const selectedItem = sizeCombo ? sizeCombo.dataItem() : null;

            console.log("Selected value:", selectedValue);
            console.log("Selected item:", selectedItem);

            if (selectedValue && selectedItem) {
                selectedProductSize = {
                    productRangeId: selectedItem.value,
                    measuringUnitId: selectedItem.measuringUnitId,
                    rangeFrom: selectedItem.rangeFrom,
                    rangeTo: selectedItem.rangeTo,
                    unitPrice: selectedItem.unitPrice,
                    measuringUnitName: selectedItem.measuringUnitName,
                    measuringUnitAbbreviation: selectedItem.measuringUnitAbbreviation
                };

                console.log("Selected product size:", selectedProductSize);

                // Populate unit price
                const unitPriceElement = document.getElementById('unitPrice');
                if (unitPriceElement) {
                    unitPriceElement.value = parseFloat(selectedProductSize.unitPrice).toFixed(2);
                    console.log("Unit price set to:", unitPriceElement.value);
                }

                // Set default sale price to unit price
                const salePriceElement = document.getElementById('salePrice');
                if (salePriceElement) {
                    salePriceElement.value = parseFloat(selectedProductSize.unitPrice).toFixed(2);
                    console.log("Sale price set to:", salePriceElement.value);
                }

                // Set base unit ID from product size
                baseUnitId = selectedItem.measuringUnitId;
                
                // Calculate payable amount
                calculatePayableAmount();
                
                // Load and display available stock in the product size's unit
                const productCombo = $("#productSelect").data("kendoComboBox");
                const productId = productCombo ? productCombo.value() : null;
                if (productId) {
                    loadAvailableStockInProductSizeUnit(productId, selectedItem.measuringUnitId);
                }
            } else {
                selectedProductSize = null;
                resetProductFields();
            }
        }

        // Function to load available stock in product size's unit
        function loadAvailableStockInProductSizeUnit(productId, productSizeUnitId) {
            if (!productId || !productSizeUnitId) {
                console.log("Missing required data for loading stock");
                return;
            }

            // Get stock in base unit along with base unit ID
            fetch(`/Sales/GetAvailableStock?productId=${productId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const stockInBaseUnit = data.availableQuantity;
                        const productBaseUnitId = data.baseUnitId;
                        
                        // If product size unit is same as base unit, no conversion needed
                        if (!productBaseUnitId || productSizeUnitId == productBaseUnitId) {
                            currentAvailableStock = stockInBaseUnit;
                            updateStockDisplay();
                        } else {
                            // Convert stock from base unit to product size unit
                            console.log('Converting stock:', {
                                stockInBaseUnit: stockInBaseUnit,
                                fromUnitId: productBaseUnitId,
                                toUnitId: productSizeUnitId
                            });
                            
                            fetch(`/Sales/ConvertUnitAndGetStock?productId=${productId}&fromUnitId=${productBaseUnitId}&toUnitId=${productSizeUnitId}&stockInBaseUnit=${stockInBaseUnit}`)
                                .then(response => response.json())
                                .then(conversionData => {
                                    if (conversionData.success) {
                                        currentAvailableStock = conversionData.convertedStock;
                                        updateStockDisplay();
                                        console.log('Stock converted to product size unit:', {
                                            baseStock: stockInBaseUnit,
                                            baseUnitId: productBaseUnitId,
                                            productSizeUnitId: productSizeUnitId,
                                            convertedStock: conversionData.convertedStock,
                                            conversionFactor: conversionData.conversionFactor
                                        });
                                    } else {
                                        console.warn('Conversion failed, using base unit stock');
                                        // Fallback to base unit if conversion fails
                                        currentAvailableStock = stockInBaseUnit;
                                        updateStockDisplay();
                                    }
                                })
                                .catch(error => {
                                    console.error('Error converting stock:', error);
                                    currentAvailableStock = stockInBaseUnit;
                                    updateStockDisplay();
                                });
                        }
                    } else {
                        currentAvailableStock = 0;
                        updateStockDisplay();
                    }
                })
                .catch(error => {
                    console.error('Error loading available stock:', error);
                    currentAvailableStock = 0;
                    updateStockDisplay();
                });
        }

        function calculatePayableAmount() {
            let quantity = parseFloat(document.getElementById('quantity').value) || 0;
            const salePrice = parseFloat(document.getElementById('salePrice').value) || 0;
            const discount = parseFloat(document.getElementById('discountAmount').value) || 0;
            
            // Calculate payable amount (no unit conversion needed - quantity is already in product size unit)
            const totalDiscount = discount * quantity;
            const payable = (salePrice * quantity) - totalDiscount;
            document.getElementById('payableAmount').value = payable.toFixed(2);
            console.log('Payable calculation:', {
                quantity: quantity,
                salePrice: salePrice,
                discount: discount,
                totalDiscount: totalDiscount,
                subtotal: salePrice * quantity,
                payable: payable
            });
        }
                function showWarningMessage(message) {
            // Remove existing warning messages
            $('.alert-warning').remove();

            // Create warning alert
            var alertHtml = '<div class="alert alert-warning alert-dismissible fade show" role="alert" style="position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px;">' +
                '<i class="fa-solid fa-exclamation-triangle me-2"></i>' +
                message +
                '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>' +
                '</div>';

            $('body').append(alertHtml);

            // Auto-hide after 5 seconds
            setTimeout(function() {
                $('.alert-warning').fadeOut();
            }, 5000);
        }
        function addProductToTable() {
            debugger;
            const productCombo = $("#productSelect").data("kendoComboBox");
            const productId = productCombo ? productCombo.value() : null;
            
            // Get product details from the selected item
            let productName = '';
            if (productCombo && productId) {
                const selectedDataItem = productCombo.dataItem();
                productName = selectedDataItem ? (selectedDataItem.productName || selectedDataItem.text || '') : productCombo.text();
            }
            
            let quantity = parseFloat(document.getElementById('quantity').value) || 0;
            const unitPrice = parseFloat(document.getElementById('unitPrice').value) || 0;
            const salePrice = parseFloat(document.getElementById('salePrice').value) || 0;
            const discount = parseFloat(document.getElementById('discountAmount').value) || 0;
            let payable = parseFloat(document.getElementById('payableAmount').value) || 0;
            
            // Get measuring unit abbreviation from product size
            let measuringUnitAbbreviation = 'N/A';
            if (selectedProductSize) {
                measuringUnitAbbreviation = selectedProductSize.measuringUnitAbbreviation || 'N/A';
            }
            
            // Quantity is in product size unit - will be converted to base unit for storage
            let quantityInBaseUnit = quantity;
            
            const totalDiscount = discount * quantity; // Calculate total discount from per-unit discount
            
            console.log('Adding product to table:', {
                productId: productId,
                measuringUnitAbbreviation: measuringUnitAbbreviation,
                productName: productName,
                quantity: quantity,
                salePrice: salePrice,
                discount: discount,
                totalDiscount: totalDiscount,
                payable: payable
            });
            
            // Validation
            if (!productId) {
                showWarningMessage('Please select a product.');
                return;
            }

            if (!selectedProductSize) {
                showWarningMessage('Please select a product size.');
                return;
            }

            if (quantity <= 0) {
                showWarningMessage('Please enter a valid quantity.');
                return;
            }

            // Check stock availability
            if (quantity > currentAvailableStock) {
                showWarningMessage(`Insufficient stock! Available quantity: ${currentAvailableStock}. You cannot add more than the available stock.`);
                return;
            }

            if (salePrice <= 0) {
                showWarningMessage('Please enter a valid sale price.');
                return;
            }

            // Check for duplicate products
            // Allow duplicates only if: different productRangeId (size) OR different unitPrice
            // Prevent duplicate if: same productId AND same productRangeId AND same unitPrice
            const existingRows = document.querySelectorAll('#saleDetailsBody tr');
            for (let row of existingRows) {
                const existingProductId = row.querySelector('input[name*=".ProductId"]').value;
                const existingProductRangeId = row.querySelector('input[name*=".ProductRangeId"]').value;
                const existingUnitPrice = parseFloat(row.querySelector('input[name*=".UnitPrice"]').value) || 0;
                
                // Prevent duplicate if same product, same size, and same unit price
                if (existingProductId === productId && 
                    existingProductRangeId === selectedProductSize.productRangeId.toString() && 
                    Math.abs(existingUnitPrice - unitPrice) < 0.01) {
                    showWarningMessage('This product with the same size and unit price has already been added. Please remove it first, update the quantity, or use a different unit price.');
                    return;
                }
            }

            // Convert quantity to base unit if needed (for storage in database)
            // Get product's base unit first
            fetch(`/Sales/GetAvailableStock?productId=${productId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.baseUnitId) {
                        const productBaseUnitId = data.baseUnitId;
                        const productSizeUnitId = selectedProductSize.measuringUnitId;
                        
                        // If product size unit is same as base unit, no conversion needed
                        if (productSizeUnitId == productBaseUnitId) {
                            quantityInBaseUnit = quantity;
                            addRowToTable(quantity, quantityInBaseUnit);
                        } else {
                            // Convert quantity from product size unit to base unit
                            console.log('Converting quantity to base unit:', {
                                quantity: quantity,
                                fromUnitId: productSizeUnitId,
                                toUnitId: productBaseUnitId
                            });
                            
                            fetch(`/Sales/ConvertQuantityToBaseUnit?productId=${productId}&fromUnitId=${productSizeUnitId}&toUnitId=${productBaseUnitId}&quantity=${quantity}`)
                                .then(response => response.json())
                                .then(conversionData => {
                                    if (conversionData.success) {
                                        quantityInBaseUnit = conversionData.convertedQuantity;
                                        console.log('Quantity converted to base unit:', {
                                            originalQuantity: quantity,
                                            baseUnitQuantity: quantityInBaseUnit,
                                            conversionFactor: conversionData.conversionFactor
                                        });
                                        addRowToTable(quantity, quantityInBaseUnit);
                                    } else {
                                        console.warn('Conversion failed, using original quantity');
                                        quantityInBaseUnit = quantity;
                                        addRowToTable(quantity, quantityInBaseUnit);
                                    }
                                })
                                .catch(error => {
                                    console.error('Error converting quantity:', error);
                                    quantityInBaseUnit = quantity;
                                    addRowToTable(quantity, quantityInBaseUnit);
                                });
                        }
                    } else {
                        // No base unit found, use quantity as is
                        quantityInBaseUnit = quantity;
                        addRowToTable(quantity, quantityInBaseUnit);
                    }
                })
                .catch(error => {
                    console.error('Error getting base unit:', error);
                    quantityInBaseUnit = quantity;
                    addRowToTable(quantity, quantityInBaseUnit);
                });

            // Function to add row to table with both display and base unit quantities
            function addRowToTable(displayQuantity, baseUnitQuantity) {
                const tbody = document.getElementById('saleDetailsBody');
                const newRow = document.createElement('tr');

                newRow.innerHTML = `
                    <td>${measuringUnitAbbreviation}</td>
                    <td>${productName || 'Product'}</td>
                    <td>Rs${discount.toFixed(2)}</td>
                    <td>Rs${salePrice.toFixed(2)}</td>
                    <td>${displayQuantity.toFixed(2)} ${measuringUnitAbbreviation !== 'N/A' ? measuringUnitAbbreviation : ''}</td>
                    <td>Rs${totalDiscount.toFixed(2)}</td>
                    <td>Rs${payable.toFixed(2)}</td>
                    <td>
                        <button type="button" class="btn btn-warning btn-sm edit-row me-1" title="Edit this item">
                            <i class="fa-solid fa-edit"></i>
                        </button>
                        <button type="button" class="btn btn-danger btn-sm remove-row" title="Remove this item">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </td>
                    <input type="hidden" name="SaleDetails[${rowIndex}].ProductId" value="${productId}" />
                    <input type="hidden" name="SaleDetails[${rowIndex}].ProductRangeId" value="${selectedProductSize.productRangeId}" />
                    <input type="hidden" name="SaleDetails[${rowIndex}].ProductSize" value="${measuringUnitAbbreviation}" />
                    <input type="hidden" name="SaleDetails[${rowIndex}].UnitPrice" value="${unitPrice.toFixed(2)}" />
                    <input type="hidden" name="SaleDetails[${rowIndex}].Quantity" value="${baseUnitQuantity}" />
                    <input type="hidden" name="SaleDetails[${rowIndex}].DisplayQuantity" value="${displayQuantity}" />
                    <input type="hidden" name="SaleDetails[${rowIndex}].SalePrice" value="${salePrice.toFixed(2)}" />
                    <input type="hidden" name="SaleDetails[${rowIndex}].LineDiscountAmount" value="${totalDiscount.toFixed(2)}" />
                    <input type="hidden" name="SaleDetails[${rowIndex}].PayableAmount" value="${payable.toFixed(2)}" />
                `;

                tbody.appendChild(newRow);
                rowIndex++;

                // Update available stock after adding item
                updateAvailableStockAfterAdd(baseUnitQuantity);

                // Reset fields
                resetFields();
                updateTotals();
                
                // Show success message
                showSuccessMessage('Product added to sale successfully!');

                // Focus on product selection for next item
                setTimeout(() => {
                    const productCombo = $("#productSelect").data("kendoComboBox");
                    if (productCombo) {
                        productCombo.focus();
                    }
                }, 100);
            }

        }

        // Function to restore stock after removing an item
        function restoreStockAfterRemove(productId, productRangeId, quantityInBaseUnit) {
            // Get the current product size selection to determine the unit
            const productCombo = $("#productSelect").data("kendoComboBox");
            const currentProductId = productCombo ? productCombo.value() : null;
            
            // Only restore stock if the removed item is from the currently selected product
            if (currentProductId && currentProductId == productId && selectedProductSize) {
                const productSizeUnitId = selectedProductSize.measuringUnitId;
                
                // Get base unit and convert quantityInBaseUnit to product size unit for display
                fetch(`/Sales/GetAvailableStock?productId=${productId}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success && data.baseUnitId) {
                            const productBaseUnitId = data.baseUnitId;
                            
                            if (productSizeUnitId == productBaseUnitId) {
                                // Same unit, just add back
                                currentAvailableStock = currentAvailableStock + quantityInBaseUnit;
                                updateStockDisplay();
                            } else {
                                // Convert quantityInBaseUnit to product size unit for display
                                fetch(`/Sales/ConvertUnitAndGetStock?productId=${productId}&fromUnitId=${productBaseUnitId}&toUnitId=${productSizeUnitId}&stockInBaseUnit=${quantityInBaseUnit}`)
                                    .then(response => response.json())
                                    .then(conversionData => {
                                        if (conversionData.success) {
                                            const quantityInProductSizeUnit = conversionData.convertedStock;
                                            currentAvailableStock = currentAvailableStock + quantityInProductSizeUnit;
                                            updateStockDisplay();
                                        } else {
                                            // Fallback: just add back base unit (may show incorrect value)
                                            currentAvailableStock = currentAvailableStock + quantityInBaseUnit;
                                            updateStockDisplay();
                                        }
                                    })
                                    .catch(error => {
                                        console.error('Error converting quantity for stock restore:', error);
                                        currentAvailableStock = currentAvailableStock + quantityInBaseUnit;
                                        updateStockDisplay();
                                    });
                            }
                        } else {
                            // No base unit, just add back
                            currentAvailableStock = currentAvailableStock + quantityInBaseUnit;
                            updateStockDisplay();
                        }
                    })
                    .catch(error => {
                        console.error('Error restoring stock after remove:', error);
                    });
            }
        }

        // Function to update available stock after adding an item
        function updateAvailableStockAfterAdd(quantityInBaseUnit) {
            // Deduct the quantity from current available stock
            // currentAvailableStock is in product size unit, so we need to convert quantityInBaseUnit back to product size unit
            const productCombo = $("#productSelect").data("kendoComboBox");
            const productId = productCombo ? productCombo.value() : null;
            
            if (productId && selectedProductSize) {
                const productSizeUnitId = selectedProductSize.measuringUnitId;
                
                // Get base unit and convert quantityInBaseUnit back to product size unit for display
                fetch(`/Sales/GetAvailableStock?productId=${productId}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success && data.baseUnitId) {
                            const productBaseUnitId = data.baseUnitId;
                            
                            if (productSizeUnitId == productBaseUnitId) {
                                // Same unit, just deduct
                                currentAvailableStock = currentAvailableStock - quantityInBaseUnit;
                                updateStockDisplay();
                            } else {
                                // Convert quantityInBaseUnit to product size unit for display
                                fetch(`/Sales/ConvertUnitAndGetStock?productId=${productId}&fromUnitId=${productBaseUnitId}&toUnitId=${productSizeUnitId}&stockInBaseUnit=${quantityInBaseUnit}`)
                                    .then(response => response.json())
                                    .then(conversionData => {
                                        if (conversionData.success) {
                                            const quantityInProductSizeUnit = conversionData.convertedStock;
                                            currentAvailableStock = currentAvailableStock - quantityInProductSizeUnit;
                                            updateStockDisplay();
                                        } else {
                                            // Fallback: just deduct from base unit (may show incorrect value)
                                            currentAvailableStock = currentAvailableStock - quantityInBaseUnit;
                                            updateStockDisplay();
                                        }
                                    })
                                    .catch(error => {
                                        console.error('Error converting quantity for stock update:', error);
                                        currentAvailableStock = currentAvailableStock - quantityInBaseUnit;
                                        updateStockDisplay();
                                    });
                            }
                        } else {
                            // No base unit, just deduct
                            currentAvailableStock = currentAvailableStock - quantityInBaseUnit;
                            updateStockDisplay();
                        }
                    })
                    .catch(error => {
                        console.error('Error updating stock after add:', error);
                    });
            }
        }

        function resetFields() {
            // Reset product dropdown
            const productCombo = $("#productSelect").data("kendoComboBox");
            if (productCombo) {
                productCombo.value("");
            }
            
            // Reset product size dropdown
            const sizeCombo = $("#productSizeSelect").data("kendoComboBox");
            if (sizeCombo) {
                sizeCombo.value("");
                sizeCombo.dataSource.data([]);
                sizeCombo.enable(false);
            }

            // Unit dropdown removed - no longer needed
            baseUnitId = null;

            // Reset other fields
            document.getElementById('quantity').value = "1";
            document.getElementById('unitPrice').value = "0";
            document.getElementById('salePrice').value = "0";
            document.getElementById('discountAmount').value = "0";
            document.getElementById('payableAmount').value = "0";
            selectedProductSize = null;
            currentAvailableStock = 0;
            
            // Reset any validation classes
            const formElements = document.querySelectorAll('#productSelect, #productSizeSelect, #quantity, #unitPrice, #salePrice, #discountAmount, #payableAmount');
            formElements.forEach(element => {
                element.classList.remove('is-invalid', 'is-valid');
            });
            
            // Force focus on product select
            setTimeout(() => {
                const productCombo = $("#productSelect").data("kendoComboBox");
                if (productCombo) {
                    productCombo.focus();
                }
            }, 100);

            // Reset quantity input styling and attributes
            const quantityInput = document.getElementById('quantity');
            quantityInput.classList.remove('is-invalid', 'is-valid');
            quantityInput.removeAttribute('max');
            quantityInput.removeAttribute('placeholder');
            quantityInput.setCustomValidity('');

            // Reset quantity label
            const quantityLabel = document.querySelector('label[for="quantity"]');
            if (quantityLabel) {
                quantityLabel.innerHTML = 'Quantity:';
            }

            // Reset payment method fields
            document.getElementById('paymentMethodSelect').value = '';
            document.getElementById('onlineAccountSelect').value = '';
            document.getElementById('onlineAccountDiv').style.display = 'none';
        }


        function resetProductFields() {
            document.getElementById('quantity').value = "1";
            document.getElementById('unitPrice').value = "0";
            document.getElementById('salePrice').value = "0";
            document.getElementById('discountAmount').value = "0";
            document.getElementById('payableAmount').value = "0";

            // Reset quantity input styling
            const quantityInput = document.getElementById('quantity');
            quantityInput.classList.remove('is-invalid', 'is-valid');
            quantityInput.setCustomValidity('');
        }

        function populateExistingSaleDetails() {
            console.log('Populating existing sale details for editing...');

            // Get the existing sale details from the model (without quotes to get actual array)
            const saleDetails = @Html.Raw(Json.Serialize(Model.SaleDetails ?? new List<SaleDetailViewModel>()));

            console.log('Sale details type:', typeof saleDetails);
            console.log('Sale details:', saleDetails);

            // Check if saleDetails is an array and has items
            if (Array.isArray(saleDetails) && saleDetails.length > 0) {
                console.log('Found existing sale details:', saleDetails);

                // Clear any existing rows
                document.getElementById('saleDetailsBody').innerHTML = '';
                rowIndex = 0;

                // Add each existing sale detail as a row
                saleDetails.forEach(function(detail) {
                    addExistingProductToTable(detail);
                });

                // Update totals
                updateTotals();

                showSuccessMessage('Existing sale details loaded successfully!');
            } else {
                console.log('No existing sale details found or saleDetails is not an array');
            }
        }

        function addExistingProductToTable(detail) {
            // Validate detail object
            if (!detail) {
                console.error('Detail object is null or undefined');
                return;
            }

            console.log('Adding existing product to table, detail object:', detail);
            console.log('Detail object keys:', Object.keys(detail));

            // Get product name and measuring unit abbreviation from the detail object
            const productName = detail.productName || detail.ProductName || detail.product_name || 'Product';
            
            // Try multiple property name variations for measuring unit abbreviation
            let measuringUnitAbbreviation = 'N/A';
            if (detail.measuringUnitAbbreviation && typeof detail.measuringUnitAbbreviation === 'string' && detail.measuringUnitAbbreviation.trim() !== '') {
                measuringUnitAbbreviation = detail.measuringUnitAbbreviation;
            } else if (detail.MeasuringUnitAbbreviation && typeof detail.MeasuringUnitAbbreviation === 'string' && detail.MeasuringUnitAbbreviation.trim() !== '') {
                measuringUnitAbbreviation = detail.MeasuringUnitAbbreviation;
            } else if (detail.measuring_unit_abbreviation && typeof detail.measuring_unit_abbreviation === 'string' && detail.measuring_unit_abbreviation.trim() !== '') {
                measuringUnitAbbreviation = detail.measuring_unit_abbreviation;
            } else if (detail.productSize && typeof detail.productSize === 'string' && detail.productSize.trim() !== '') {
                measuringUnitAbbreviation = detail.productSize;
            } else if (detail.ProductSize && typeof detail.ProductSize === 'string' && detail.ProductSize.trim() !== '') {
                measuringUnitAbbreviation = detail.ProductSize;
            } else if (detail.product_size && typeof detail.product_size === 'string' && detail.product_size.trim() !== '') {
                measuringUnitAbbreviation = detail.product_size;
            }

            console.log('Product Name:', productName);
            console.log('Measuring Unit Abbreviation:', measuringUnitAbbreviation);
            console.log('All detail properties:', JSON.stringify(detail));

            // Add to table
            const tbody = document.getElementById('saleDetailsBody');
            if (!tbody) {
                console.error('saleDetailsBody element not found');
                return;
            }

            const newRow = document.createElement('tr');

            // Safely get values with fallbacks
            const quantityInBaseUnit = detail.quantity || detail.Quantity || 0; // Quantity is stored in base unit
            const lineDiscountAmount = detail.lineDiscountAmount || detail.LineDiscountAmount || 0;
            const salePrice = detail.salePrice || detail.SalePrice || 0;
            const payableAmount = detail.payableAmount || detail.PayableAmount || 0;
            const unitPrice = detail.unitPrice || detail.UnitPrice || 0;
            const productId = detail.productId || detail.ProductId || '';
            const productRangeId = detail.productRangeId || detail.ProductRangeId || '';
            
            // Use measuringUnitAbbreviation for ProductSize (they should be the same)
            const productSize = measuringUnitAbbreviation !== 'N/A' ? measuringUnitAbbreviation : 
                               (detail.productSize || detail.ProductSize || '');

            // Convert quantity from base unit to product size unit for display
            // First, get the product's base unit and product size's measuring unit
            if (productId && productRangeId) {
                // Get product sizes to find the measuring unit ID for this product range
                fetch(`/Sales/GetProductSizes?productId=${productId}`)
                    .then(response => response.json())
                    .then(productSizes => {
                        // Find the product size that matches the productRangeId
                        const matchingProductSize = productSizes.find(ps => 
                            (ps.value == productRangeId || ps.productRangeId == productRangeId)
                        );
                        
                        if (matchingProductSize && matchingProductSize.measuringUnitId) {
                            const productSizeUnitId = matchingProductSize.measuringUnitId;
                            
                            // Get product's base unit
                            fetch(`/Sales/GetAvailableStock?productId=${productId}`)
                                .then(response => response.json())
                                .then(data => {
                                    if (data.success && data.baseUnitId) {
                                        const productBaseUnitId = data.baseUnitId;
                                        
                                        // If product size unit is same as base unit, no conversion needed
                                        if (productSizeUnitId == productBaseUnitId) {
                                            addRowToTableWithQuantity(newRow, quantityInBaseUnit, quantityInBaseUnit, measuringUnitAbbreviation, productName, salePrice, lineDiscountAmount, payableAmount, productId, productRangeId, productSize, unitPrice);
                                        } else {
                                            // Convert quantity from base unit to product size unit
                                            fetch(`/Sales/ConvertUnitAndGetStock?productId=${productId}&fromUnitId=${productBaseUnitId}&toUnitId=${productSizeUnitId}&stockInBaseUnit=${quantityInBaseUnit}`)
                                                .then(response => response.json())
                                                .then(conversionData => {
                                                    if (conversionData.success) {
                                                        const displayQuantity = conversionData.convertedStock;
                                                        console.log('Quantity converted for display:', {
                                                            baseQuantity: quantityInBaseUnit,
                                                            displayQuantity: displayQuantity,
                                                            unit: measuringUnitAbbreviation
                                                        });
                                                        addRowToTableWithQuantity(newRow, displayQuantity, quantityInBaseUnit, measuringUnitAbbreviation, productName, salePrice, lineDiscountAmount, payableAmount, productId, productRangeId, productSize, unitPrice);
                                                    } else {
                                                        console.warn('Conversion failed, using base unit quantity');
                                                        addRowToTableWithQuantity(newRow, quantityInBaseUnit, quantityInBaseUnit, measuringUnitAbbreviation, productName, salePrice, lineDiscountAmount, payableAmount, productId, productRangeId, productSize, unitPrice);
                                                    }
                                                })
                                                .catch(error => {
                                                    console.error('Error converting quantity:', error);
                                                    addRowToTableWithQuantity(newRow, quantityInBaseUnit, quantityInBaseUnit, measuringUnitAbbreviation, productName, salePrice, lineDiscountAmount, payableAmount, productId, productRangeId, productSize, unitPrice);
                                                });
                                        }
                                    } else {
                                        console.warn('Could not get base unit, using quantity as is');
                                        addRowToTableWithQuantity(newRow, quantityInBaseUnit, quantityInBaseUnit, measuringUnitAbbreviation, productName, salePrice, lineDiscountAmount, payableAmount, productId, productRangeId, productSize, unitPrice);
                                    }
                                })
                                .catch(error => {
                                    console.error('Error getting base unit:', error);
                                    addRowToTableWithQuantity(newRow, quantityInBaseUnit, quantityInBaseUnit, measuringUnitAbbreviation, productName, salePrice, lineDiscountAmount, payableAmount, productId, productRangeId, productSize, unitPrice);
                                });
                        } else {
                            console.warn('Could not find product size or measuring unit ID, using quantity as is');
                            addRowToTableWithQuantity(newRow, quantityInBaseUnit, quantityInBaseUnit, measuringUnitAbbreviation, productName, salePrice, lineDiscountAmount, payableAmount, productId, productRangeId, productSize, unitPrice);
                        }
                    })
                    .catch(error => {
                        console.error('Error getting product sizes:', error);
                        addRowToTableWithQuantity(newRow, quantityInBaseUnit, quantityInBaseUnit, measuringUnitAbbreviation, productName, salePrice, lineDiscountAmount, payableAmount, productId, productRangeId, productSize, unitPrice);
                    });
            } else {
                // No product ID or product range ID, use quantity as is
                addRowToTableWithQuantity(newRow, quantityInBaseUnit, quantityInBaseUnit, measuringUnitAbbreviation, productName, salePrice, lineDiscountAmount, payableAmount, productId, productRangeId, productSize, unitPrice);
            }
        }

        // Helper function to add row to table with converted quantity
        function addRowToTableWithQuantity(newRow, displayQuantity, baseUnitQuantity, measuringUnitAbbreviation, productName, salePrice, lineDiscountAmount, payableAmount, productId, productRangeId, productSize, unitPrice) {
            const tbody = document.getElementById('saleDetailsBody');
            
            // Calculate item level discount (per unit discount) based on display quantity
            const itemLevelDiscount = displayQuantity > 0 ? parseFloat(lineDiscountAmount) / displayQuantity : 0;
            
            newRow.innerHTML = `
                <td>${measuringUnitAbbreviation}</td>
                <td>${productName}</td>
                <td>Rs${itemLevelDiscount.toFixed(2)}</td>
                <td>Rs${parseFloat(salePrice).toFixed(2)}</td>
                <td>${displayQuantity.toFixed(3)} ${measuringUnitAbbreviation !== 'N/A' ? measuringUnitAbbreviation : ''}</td>
                <td>Rs${parseFloat(lineDiscountAmount).toFixed(2)}</td>
                <td>Rs${parseFloat(payableAmount).toFixed(2)}</td>
                <td>
                    <button type="button" class="btn btn-warning btn-sm edit-row me-1" title="Edit this item">
                        <i class="fa-solid fa-edit"></i>
                    </button>
                    <button type="button" class="btn btn-danger btn-sm remove-row" title="Remove this item">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                </td>
                <input type="hidden" name="SaleDetails[${rowIndex}].ProductId" value="${productId}" />
                <input type="hidden" name="SaleDetails[${rowIndex}].ProductRangeId" value="${productRangeId}" />
                <input type="hidden" name="SaleDetails[${rowIndex}].ProductSize" value="${productSize}" />
                <input type="hidden" name="SaleDetails[${rowIndex}].UnitPrice" value="${parseFloat(unitPrice).toFixed(2)}" />
                <input type="hidden" name="SaleDetails[${rowIndex}].Quantity" value="${baseUnitQuantity}" />
                <input type="hidden" name="SaleDetails[${rowIndex}].DisplayQuantity" value="${displayQuantity}" />
                <input type="hidden" name="SaleDetails[${rowIndex}].SalePrice" value="${parseFloat(salePrice).toFixed(2)}" />
                <input type="hidden" name="SaleDetails[${rowIndex}].LineDiscountAmount" value="${parseFloat(lineDiscountAmount).toFixed(2)}" />
                <input type="hidden" name="SaleDetails[${rowIndex}].PayableAmount" value="${parseFloat(payableAmount).toFixed(2)}" />
            `;

            tbody.appendChild(newRow);
            rowIndex++;
        }

        function updateTotals() {
            const rows = document.querySelectorAll('#saleDetailsBody tr');
            let totalAmount = 0;
            let totalDiscount = 0;

            console.log('=== UPDATE TOTALS CALLED ===');
            console.log('Found rows:', rows.length);

            // Calculate total from all sale items
            rows.forEach((row, index) => {
                const payableText = row.querySelector('td:nth-child(7)').textContent;
                const discountText = row.querySelector('td:nth-child(6)').textContent;
                
                const payable = parseFloat(payableText.replace('Rs', '')) || 0;
                const discount = parseFloat(discountText.replace('Rs', '')) || 0;
                
                console.log(`Row ${index}:`, {
                    payableText: payableText,
                    discountText: discountText,
                    payable: payable,
                    discount: discount
                });
                
                totalAmount += payable;
                totalDiscount += discount;
            });
            
            console.log('UpdateTotals calculation:', {
                rowsCount: rows.length,
                totalAmount: totalAmount,
                totalDiscount: totalDiscount
            });

            // Update Total Amount
            const totalAmountElement = document.getElementById('TotalAmount');
            if (totalAmountElement) {
                totalAmountElement.value = totalAmount.toFixed(2);
                console.log('Updated TotalAmount field to:', totalAmount.toFixed(2));
            } else {
                console.error('TotalAmount element not found!');
            }

            // Update Total Discount
            document.getElementById('DiscountAmount').value = totalDiscount.toFixed(2);

            // Get received and previous due amounts
            const receivedAmount = parseFloat(document.getElementById('ReceivedAmount').value) || 0;
            const previousDueAmount = parseFloat(document.getElementById('PreviousDue').value) || 0;

            // Calculate due amount (Total Amount is already net after line discounts, so we don't subtract totalDiscount again)
            // Due Amount = Total Amount - Received Amount + Previous Due
            // const dueAmount = Math.max(0, totalAmount - receivedAmount + previousDueAmount);
            const dueAmount = Math.max(0, totalAmount - receivedAmount);

            // Update Due Amount
            document.getElementById('DueAmount').value = dueAmount.toFixed(2);

            // Pay Now field is optional - don't auto-sync with Received Amount
            // User can enter any amount they want to pay now

            // Visual feedback for amounts
            updateAmountDisplay();
        }

        function updateReceivedAmount() {
            const payNow = parseFloat(document.getElementById('PayNow').value) || 0;
            document.getElementById('ReceivedAmount').value = payNow.toFixed(2);
            updateTotals();

            // Show helpful message when payment is complete
            const totalAmount = parseFloat(document.getElementById('TotalAmount').value) || 0;
            const discountAmount = parseFloat(document.getElementById('DiscountAmount').value) || 0;
            const netTotal = totalAmount - discountAmount;

            if (payNow >= netTotal && netTotal > 0) {
                showSuccessMessage('Payment complete! No amount due.');
            }
        }

        function updateReceivedAmountFromReceived() {
            const receivedAmount = parseFloat(document.getElementById('ReceivedAmount').value) || 0;
            document.getElementById('PayNow').value = receivedAmount.toFixed(2);
            updateTotals();
        }

        function updateAmountDisplay() {
            const totalAmount = parseFloat(document.getElementById('TotalAmount').value) || 0;
            const receivedAmount = parseFloat(document.getElementById('ReceivedAmount').value) || 0;
            const dueAmount = parseFloat(document.getElementById('DueAmount').value) || 0;

            // Add visual indicators
            const totalElement = document.getElementById('TotalAmount');
            const receivedElement = document.getElementById('ReceivedAmount');
            const dueElement = document.getElementById('DueAmount');

            // Reset classes
            totalElement.classList.remove('text-success', 'text-warning');
            receivedElement.classList.remove('text-success', 'text-warning');
            dueElement.classList.remove('text-success', 'text-danger', 'text-warning');

            // Apply visual feedback
            if (totalAmount > 0) {
                totalElement.classList.add('text-success');
            }

            if (receivedAmount > 0) {
                receivedElement.classList.add('text-success');
            }

            if (dueAmount > 0) {
                dueElement.classList.add('text-danger');
            } else if (receivedAmount > 0 && dueAmount === 0) {
                dueElement.classList.add('text-success');
            }
        }

        // Form submission handler - only for loading state
        document.getElementById('addSaleForm').addEventListener('submit', function(e) {
            console.log('=== FORM SUBMISSION EVENT TRIGGERED ===');
            console.log('Form submitting to AddSale with action type:', document.getElementById('actionType').value);
            console.log('Form action URL:', this.action);
            console.log('Form method:', this.method);

            // Sync Kendo UI combobox values with form fields before submission
            syncKendoValuesWithForm();

            // Log all form data for debugging
            const formData = new FormData(this);
            console.log('Form data being submitted:');
            for (let [key, value] of formData.entries()) {
                console.log(key + ': ' + value);
            }

            // Show loading state when form is submitting
            showLoadingState();

            // Don't prevent default - let the form submit naturally
            console.log('Form is now submitting to AddSale POST method');
        });

        // Function to sync Kendo UI combobox values with form fields
        function syncKendoValuesWithForm() {
            console.log('=== SYNCING KENDO UI VALUES WITH FORM ===');
            
            // Sync Customer ID
            const customerCombo = $("#customerSelect").data("kendoComboBox");
            if (customerCombo) {
                const customerId = customerCombo.value();
                console.log('Customer ID from Kendo combobox:', customerId);
                // Update the input field directly since it has id="customerSelect"
                document.getElementById('customerSelect').value = customerId || '';
                console.log('Customer ID set in form field:', document.getElementById('customerSelect').value);
            }

            // Sync Vendor ID
            const vendorComboForSync = $("#vendorSelect").data("kendoComboBox");
            if (vendorComboForSync) {
                const vendorId = vendorComboForSync.value();
                console.log('Vendor ID from Kendo combobox:', vendorId);
                // Update the input field directly since it has id="vendorSelect"
                document.getElementById('vendorSelect').value = vendorId || '';
                console.log('Vendor ID set in form field:', document.getElementById('vendorSelect').value);
            }
            
            // Sync Product ID (if needed)
            const productCombo = $("#productSelect").data("kendoComboBox");
            if (productCombo) {
                const productId = productCombo.value();
                console.log('Product ID from Kendo combobox:', productId);
                // Note: Product ID is handled in the table rows, not as a single form field
            }
            
            // Sync Payment Method
            const paymentMethodCombo = $("#paymentMethodSelect").data("kendoComboBox");
            if (paymentMethodCombo) {
                const paymentMethod = paymentMethodCombo.value();
                console.log('Payment Method from Kendo combobox:', paymentMethod);
                // Update the input field directly since it has id="paymentMethodSelect"
                document.getElementById('paymentMethodSelect').value = paymentMethod || '';
                console.log('Payment Method set in form field:', document.getElementById('paymentMethodSelect').value);
            }
            
            // Sync Online Account ID
            const onlineAccountCombo = $("#onlineAccountSelect").data("kendoComboBox");
            if (onlineAccountCombo) {
                const onlineAccountId = onlineAccountCombo.value();
                console.log('Online Account ID from Kendo combobox:', onlineAccountId);
                // Update the input field directly since it has id="onlineAccountSelect"
                document.getElementById('onlineAccountSelect').value = onlineAccountId || '';
                console.log('Online Account ID set in form field:', document.getElementById('onlineAccountSelect').value);
            }
            
            console.log('=== KENDO UI VALUES SYNCED ===');
        }

        // Function to reset customer dropdown specifically
        function resetCustomerDropdown() {
            console.log('=== RESETTING CUSTOMER DROPDOWN ===');
            const customerCombo = $("#customerSelect").data("kendoComboBox");
            if (customerCombo) {
                customerCombo.value('');
                customerCombo.text('');
                console.log('Customer combobox reset');
            }
            
            // Also reset the previous due amount
            $('#PreviousDue').val('0.00');
            const previousDueElement = document.getElementById('PreviousDue');
            if (previousDueElement) {
                previousDueElement.classList.remove('text-success', 'text-danger');
                previousDueElement.classList.add('text-muted');
            }
        }

        function clearValidationMessages() {
            const existingAlerts = document.querySelectorAll('.alert-danger, .alert-success');
            existingAlerts.forEach(alert => alert.remove());
        }

        function clearValidationStyling() {
            // Clear validation styling from form elements
            const formElements = document.querySelectorAll('#addSaleForm input, #addSaleForm select, #addSaleForm textarea');
            formElements.forEach(element => {
                element.classList.remove('is-invalid', 'is-valid');
            });
        }

        function validateForm() {
            debugger;
            console.log('=== VALIDATING FORM ===');

            const customerCombo = $("#customerSelect").data("kendoComboBox");
            const customerId = customerCombo ? customerCombo.value() : null;
            const vendorCombo = $("#vendorSelect").data("kendoComboBox");
            const vendorId = vendorCombo ? vendorCombo.value() : null;
            const saleDetailsCount = document.querySelectorAll('#saleDetailsBody tr').length;
            const totalAmount = parseFloat(document.getElementById('TotalAmount').value) || 0;
            const receivedAmount = parseFloat(document.getElementById('ReceivedAmount').value) || 0;
            const dueAmount = parseFloat(document.getElementById('DueAmount').value) || 0;
            const paymentMethodCombo = $("#paymentMethodSelect").data("kendoComboBox");
            const paymentMethod = paymentMethodCombo ? paymentMethodCombo.value() : null;
            const onlineAccountCombo = $("#onlineAccountSelect").data("kendoComboBox");
            const onlineAccountId = onlineAccountCombo ? onlineAccountCombo.value() : null;

            console.log('Validation values:', {
                customerId: customerId,
                vendorId : vendorId,
                saleDetailsCount: saleDetailsCount,
                totalAmount: totalAmount,
                receivedAmount: receivedAmount,
                dueAmount: dueAmount,
                paymentMethod: paymentMethod,
                onlineAccountId: onlineAccountId
            });

            // Clear previous validation messages and styling
            clearValidationMessages();
            clearValidationStyling();

            let isValid = true;
            let errorMessages = [];

            if ((!customerId || customerId === '') && (!vendorId || vendorId === '')) {
                showWarningMessage("Please select a customer or vendor.");
                isValid = false;
            }

            if (customerId && vendorId) {
                showWarningMessage("Please select either a customer or a vendor, not both.");
                isValid = false;
            }

            if (saleDetailsCount === 0) {
                showWarningMessage("Please add at least one product to the sale.");
                isValid = false;
            }

            if (totalAmount <= 0) {
                showWarningMessage("Total amount must be greater than zero.");
                isValid = false;
            }

            if (receivedAmount < 0) {
                showWarningMessage("Received amount cannot be negative.");
                isValid = false;
            }

            if (dueAmount < 0) {
                showWarningMessage("Due amount cannot be negative.");
                isValid = false;
            }

            // Payment method validation
            if (!paymentMethod || paymentMethod === '') {
                showWarningMessage("Please select a payment method.");
                // Add visual feedback
                document.getElementById('paymentMethodSelect').classList.add('is-invalid');
                isValid = false;
            } else {
                document.getElementById('paymentMethodSelect').classList.remove('is-invalid');

                if (paymentMethod === 'Online') {
                    // If Online payment is selected, validate online account
                    if (!onlineAccountId || onlineAccountId === '') {
                        showWarningMessage("Please select an online account for online payment.");
                        // Add visual feedback
                        document.getElementById('onlineAccountSelect').classList.add('is-invalid');
                        isValid = false;
                    } else {
                        document.getElementById('onlineAccountSelect').classList.remove('is-invalid');
                    }
                }
                
                // Validate Pay Now amount for Cash and Online payments
                if (paymentMethod === 'Cash' || paymentMethod === 'Online') {
                    const payNowAmount = parseFloat(document.getElementById('PayNow').value) || 0;
                    if (payNowAmount <= 0) {
                       showWarningMessage("Pay Now amount must be greater than zero for Cash and Online payments.");
                        // Add visual feedback
                        document.getElementById('PayNow').classList.add('is-invalid');
                        isValid = false;
                    } else {
                        document.getElementById('PayNow').classList.remove('is-invalid');
                    }
                }
            }

            console.log('Validation result:', isValid);
            console.log('Error messages:', errorMessages);

            if (!isValid) {
                // Show each validation error as a separate toaster notification
                errorMessages.forEach((message, index) => {
                    setTimeout(() => {
                        showErrorMessage(message);
                    }, index * 200); // Stagger the toasters by 200ms each
                });
            }

            return isValid;
        }


        function showLoadingState() {
            // Disable all form elements
            const formElements = document.querySelectorAll('#addSaleForm input, #addSaleForm select, #addSaleForm textarea, #addSaleForm button');
            formElements.forEach(element => {
                element.disabled = true;
            });

            // Show loading message
            showSuccessMessage('Saving sale... Please wait.');

            // Add loading spinner to buttons
            const saveBtn = document.getElementById('saveBtn');
            const saveAndPrintBtn = document.getElementById('saveAndPrintBtn');

            if (saveBtn) {
                saveBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin me-1"></i>Saving...';
            }
            if (saveAndPrintBtn) {
                saveAndPrintBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin me-1"></i>Saving...';
            }
        }

        function resetFormAfterSuccess() {
            // Re-enable all form elements
            const formElements = document.querySelectorAll('#addSaleForm input, #addSaleForm select, #addSaleForm textarea, #addSaleForm button');
            formElements.forEach(element => {
                element.disabled = false;
            });

            // Reset button text
            const saveBtn = document.getElementById('saveBtn');
            const saveAndPrintBtn = document.getElementById('saveAndPrintBtn');

            if (saveBtn) {
                saveBtn.innerHTML = '<i class="fa-solid fa-save me-1"></i>Save Sale';
            }
            if (saveAndPrintBtn) {
                saveAndPrintBtn.innerHTML = '<i class="fa-solid fa-print me-1"></i>Save and Print';
            }

        }


        function showValidationError(message) {
            clearValidationMessages();

            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-danger alert-dismissible fade show';
            alertDiv.innerHTML = `
                <i class="fa-solid fa-exclamation-triangle me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;

            const form = document.getElementById('addSaleForm');
            form.insertBefore(alertDiv, form.firstChild);
        }

        function showSuccessMessage(message) {
            clearValidationMessages();

            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-success alert-dismissible fade show';
            alertDiv.innerHTML = `
                <i class="fa-solid fa-check-circle me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;

            const form = document.getElementById('addSaleForm');
            form.insertBefore(alertDiv, form.firstChild);

            // Auto-hide after 3 seconds
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 3000);
        }

        // AJAX Save Sale function
        function saveSale() {
            console.log('=== AJAX Save Sale called ===');

            // Validate form
            if (!validateForm()) {
                console.log('Form validation failed - stopping submission');
                return false;
            }

            console.log('Form validation passed - proceeding with AJAX submission');
            showLoadingState();

            try {
            // Collect form data
            const formData = collectFormData('save');
                console.log('Form data collected:', formData);

            // Make AJAX call
            $.post('@Url.Action("AddSale", "Sales")', formData)
                .done(function(response) {
                    console.log('AJAX Save Sale success:', response);
                    hideLoadingState();

                    if (response.success) {
                        showSuccessMessage('Sale saved successfully!');
                        // alert('Sale saved successfully!');
                        // Reset form after successful save
                        resetAllFormFields();
                    } else {
                        showErrorMessage(response.message || 'Failed to save sale');
                    }
                })
                .fail(function(xhr, status, error) {
                    console.error('AJAX Save Sale error:', error);
                        console.error('Response:', xhr.responseText);
                    hideLoadingState();
                    showErrorMessage('Error saving sale: ' + error);
                });
            } catch (error) {
                console.error('Error in saveSale function:', error);
                hideLoadingState();
                showErrorMessage('Error preparing sale data: ' + error.message);
            }
        }

        // AJAX Save and Print function - automatically prints both customer and merchant copies
        function saveAndPrintSale() {
            console.log('=== AJAX Save and Print called - will print both copies ===');
            
            // Validate form
            if (!validateForm()) {
                console.log('Form validation failed - stopping submission');
                return false;
            }

            console.log('Form validation passed - proceeding with AJAX submission');
            showLoadingState();

            try {
            // Collect form data
            const formData = collectFormData('saveAndPrint');
                console.log('Form data collected:', formData);
            
            // Make AJAX call
            $.post('@Url.Action("AddSale", "Sales")', formData)
                .done(function(response) {
                    console.log('AJAX Save and Print success:', response);
                    hideLoadingState();
                    
                    if (response.success) {
                        showSuccessMessage('Sale saved successfully!');
                        // Reset form after successful save
                        resetAllFormFields();
                        // Open print windows for both customer and merchant copies in separate tabs
                        if (response.saleId) {
                            // Open customer copy in new tab and print
                            const customerPrintUrl = '@Url.Action("PrintReceipt", "Sales")' + '/' + response.saleId + '?print=true&merchantCopy=false';
                            const customerWindow = window.open(customerPrintUrl, '_blank');
                            
                            // Open merchant copy in another new tab after a delay
                            setTimeout(function() {
                                const merchantPrintUrl = '@Url.Action("PrintReceipt", "Sales")' + '/' + response.saleId + '?print=true&merchantCopy=true';
                                const merchantWindow = window.open(merchantPrintUrl, '_blank');
                                
                                // Show notification about both copies being opened
                                showSuccessMessage('Both Customer Copy and Merchant Copy have been opened in separate tabs!');
                            }, 1000); // 1 second delay between tabs
                        }
                    } else {
                        showErrorMessage(response.message || 'Failed to save sale');
                    }
                })
                .fail(function(xhr, status, error) {
                    console.error('AJAX Save and Print error:', error);
                        console.error('Response:', xhr.responseText);
                    hideLoadingState();
                    showErrorMessage('Error saving sale: ' + error);
                });
            } catch (error) {
                console.error('Error in saveAndPrintSale function:', error);
                hideLoadingState();
                showErrorMessage('Error preparing sale data: ' + error.message);
            }
        }

        // AJAX Save and Print with specific template
        function saveAndPrintWithTemplate(templateType) {
            console.log('=== AJAX Save and Print called with template type:', templateType);
            
            // Validate form
            if (!validateForm()) {
                console.log('Form validation failed - stopping submission');
                return false;
            }

            console.log('Form validation passed - proceeding with AJAX submission');
            showLoadingState();

            // Collect form data
            const formData = collectFormData('saveAndPrint');
            
            // Make AJAX call
            $.post('@Url.Action("AddSale", "Sales")', formData)
                .done(function(response) {
                    console.log('AJAX Save and Print success:', response);
                    hideLoadingState();
                    
                    if (response.success) {
                        showSuccessMessage('Sale saved successfully!');
                        // Reset form after successful save
                        resetAllFormFields();
                        // Open print window with selected template
                        if (response.saleId) {
                            // Use the new print receipt system
                            window.open('@Url.Action("PrintReceipt", "Sales")' + '/' + response.saleId + '?print=true', '_blank');
                        }
                    } else {
                        showErrorMessage(response.message || 'Failed to save sale');
                    }
                })
                .fail(function(xhr, status, error) {
                    console.error('AJAX Save and Print error:', error);
                    hideLoadingState();
                    showErrorMessage('Error saving sale: ' + error);
                });
        }

        // Collect form data for AJAX submission
        function collectFormData(actionType) {
            // Sync Kendo UI values with form fields before collecting data
            syncKendoValuesWithForm();
            
            const formData = {};

            // Add anti-forgery token
            formData['__RequestVerificationToken'] = $('input[name="__RequestVerificationToken"]').val();

            // Add action type
            formData['ActionType'] = actionType;

            // Add SaleId if editing
            const saleId = $('#saleId').val();
            if (saleId) {
                formData['SaleId'] = saleId;
                console.log('SaleId included in form data:', saleId);
            }

            // Add main form fields
            formData['CustomerId'] = $('#customerSelect').val();
            formData['VendorId'] = $('#vendorSelect').val();
            formData['BillNo'] = $('#BillNo').val();
            formData['SaleDate'] = $('#SaleDate').val();
            formData['PayNow'] = $('#PayNow').val();
            formData['TotalAmount'] = $('#TotalAmount').val();
            formData['DiscountAmount'] = $('#DiscountAmount').val();
            formData['ReceivedAmount'] = $('#ReceivedAmount').val();
            formData['DueAmount'] = $('#DueAmount').val();
            formData['PreviousDue'] = $('#PreviousDue').val();
            formData['Description'] = $('#Description').val();
            formData['PaymentMethod'] = $('#paymentMethodSelect').val();
            formData['OnlineAccountId'] = $('#onlineAccountSelect').val();

            // Add SaleDetails
            const saleDetailsRows = document.querySelectorAll('#saleDetailsBody tr');
            saleDetailsRows.forEach((row, index) => {
                const productId = row.querySelector('input[name*=".ProductId"]').value;
                const productRangeId = row.querySelector('input[name*=".ProductRangeId"]').value;
                const productSize = row.querySelector('input[name*=".ProductSize"]').value;
                const unitPrice = row.querySelector('input[name*=".UnitPrice"]').value;
                const quantity = row.querySelector('input[name*=".Quantity"]').value;
                const salePrice = row.querySelector('input[name*=".SalePrice"]').value;
                const lineDiscountAmount = row.querySelector('input[name*=".LineDiscountAmount"]').value;
                const payableAmount = row.querySelector('input[name*=".PayableAmount"]').value;

                formData[`SaleDetails[${index}].ProductId`] = productId;
                formData[`SaleDetails[${index}].ProductRangeId`] = productRangeId;
                formData[`SaleDetails[${index}].ProductSize`] = productSize;
                // Add MeasuringUnitAbbreviation - it should be the same as ProductSize
                formData[`SaleDetails[${index}].MeasuringUnitAbbreviation`] = productSize;
                formData[`SaleDetails[${index}].UnitPrice`] = unitPrice;
                formData[`SaleDetails[${index}].Quantity`] = quantity;
                formData[`SaleDetails[${index}].SalePrice`] = salePrice;
                formData[`SaleDetails[${index}].LineDiscountAmount`] = lineDiscountAmount;
                formData[`SaleDetails[${index}].PayableAmount`] = payableAmount;
            });

            console.log('Form data collected for AJAX submission:', formData);
            return formData;
        }

        // Hide loading state
        function hideLoadingState() {
            const formElements = document.querySelectorAll('#addSaleForm input, #addSaleForm select, #addSaleForm textarea, #addSaleForm button');
            formElements.forEach(element => {
                element.disabled = false;
            });

            // Reset button text
            const saveBtn = document.querySelector('button[onclick="saveSale()"]');
            const saveAndPrintBtn = document.querySelector('button[onclick="saveAndPrintSale()"]');

            if (saveBtn) {
                saveBtn.innerHTML = '<i class="fa-solid fa-save me-1"></i>Save Sale';
            }
            if (saveAndPrintBtn) {
                saveAndPrintBtn.innerHTML = '<i class="fa-solid fa-print me-1"></i>Save and Print';
            }
        }

        // Reset all form fields after successful save
        function resetAllFormFields() {
            console.log('=== RESETTING ALL FORM FIELDS ===');
            
            // Reset main form fields
            $('#customerSelect').val('');
            $('#vendorSelect').val('');
            $('#BillNo').val('');
            $('#SaleDate').val(new Date().toISOString().split('T')[0]);
            $('#PayNow').val('0');
            $('#TotalAmount').val('0.00');
            $('#DiscountAmount').val('0.00');
            $('#ReceivedAmount').val('0.00');
            $('#DueAmount').val('0.00');
            $('#PreviousDue').val('0.00');
            $('#Description').val('');
            
            // Reset form field values directly
            document.getElementById('customerSelect').value = '';
            document.getElementById('vendorSelect').value = '';
            document.getElementById('BillNo').value = '';
            document.getElementById('SaleDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('PayNow').value = '0';
            document.getElementById('TotalAmount').value = '0.00';
            document.getElementById('DiscountAmount').value = '0.00';
            document.getElementById('ReceivedAmount').value = '0.00';
            document.getElementById('DueAmount').value = '0.00';
            document.getElementById('PreviousDue').value = '0.00';
            document.getElementById('Description').value = '';
            
            // Reset Kendo UI comboboxes
            const customerCombo = $("#customerSelect").data("kendoComboBox");
            if (customerCombo) {
                customerCombo.value('');
                customerCombo.text('');
                console.log('Customer combobox reset');
            }

            const vendorComboForReset = $("#vendorSelect").data("kendoComboBox");
            if (vendorComboForReset) {
                vendorComboForReset.value('');
                vendorComboForReset.text('');
                console.log('Vendor combobox reset');
            }
            
            const paymentMethodCombo = $("#paymentMethodSelect").data("kendoComboBox");
            if (paymentMethodCombo) {
                paymentMethodCombo.value('');
                paymentMethodCombo.text('');
                console.log('Payment method combobox reset');
            }
            
            const onlineAccountCombo = $("#onlineAccountSelect").data("kendoComboBox");
            if (onlineAccountCombo) {
                onlineAccountCombo.value('');
                onlineAccountCombo.text('');
                onlineAccountCombo.enable(false);
                console.log('Online account combobox reset');
            }
            
            const productCombo = $("#productSelect").data("kendoComboBox");
            if (productCombo) {
                productCombo.value('');
                productCombo.text('');
                console.log('Product combobox reset');
            }
            
            const productSizeCombo = $("#productSizeSelect").data("kendoComboBox");
            if (productSizeCombo) {
                productSizeCombo.value('');
                productSizeCombo.text('');
                productSizeCombo.dataSource.data([]);
                productSizeCombo.enable(false);
                console.log('Product size combobox reset');
            }
            
            // Hide online account div
            $('#onlineAccountDiv').hide();
            $('#quantity').val('1');
            $('#unitPrice').val('0');
            $('#salePrice').val('0');
            $('#discountAmount').val('0');
            $('#payableAmount').val('0');

            // Clear sale details table
            $('#saleDetailsBody').empty();
            
            // Reset global variables
            rowIndex = 0;
            selectedProductSize = null;
            currentAvailableStock = 0;

            // Reset totals
            updateTotals();

            // Get new bill number
            getNewBillNumber();
        }

        // Get new bill number from server
        function getNewBillNumber() {
            $.get('@Url.Action("GetNextBillNumber", "Sales")')
                .done(function(response) {
                    if (response.success) {
                        $('#BillNo').val(response.billNumber);
                        console.log('New bill number loaded:', response.billNumber);
                    } else {
                        console.error('Failed to get new bill number:', response.message);
                    }
                })
                .fail(function(xhr, status, error) {
                    console.error('Error getting new bill number:', error);
                });
        }

        // Edit product from table function
        function editProductFromTable(row) {
            try {
                // Get the row data
                const productId = row.querySelector('input[name*=".ProductId"]').value;
                const productRangeId = row.querySelector('input[name*=".ProductRangeId"]').value;
                const productSize = row.querySelector('input[name*=".ProductSize"]').value;
                const unitPrice = parseFloat(row.querySelector('input[name*=".UnitPrice"]').value);
                const baseUnitQuantity = parseFloat(row.querySelector('input[name*=".Quantity"]').value); // This is in base unit
                const displayQuantityInput = row.querySelector('input[name*=".DisplayQuantity"]');
                const displayQuantity = displayQuantityInput ? parseFloat(displayQuantityInput.value) : baseUnitQuantity; // Use display quantity if available
                const salePrice = parseFloat(row.querySelector('input[name*=".SalePrice"]').value);
                const lineDiscountAmount = parseFloat(row.querySelector('input[name*=".LineDiscountAmount"]').value);

                // Get product name from the table cell
                const productName = row.cells[1].textContent;

                // Populate the form fields
                const productCombo = $("#productSelect").data("kendoComboBox");
                if (productCombo) {
                    productCombo.value(productId);
                    // Trigger product change to load sizes
                    productCombo.trigger("change");
                }

                // Wait a bit for the sizes to load, then select the correct size
                setTimeout(() => {
                    const sizeCombo = $("#productSizeSelect").data("kendoComboBox");
                    if (sizeCombo && sizeCombo.dataSource.data().length > 0) {
                        // Find the correct size in the data source
                        const sizeData = sizeCombo.dataSource.data().find(item => 
                            item.productRangeId == productRangeId
                        );
                        if (sizeData) {
                            sizeCombo.value(sizeData.value);
                            // Trigger size change to load unit price and set selectedProductSize
                            sizeCombo.trigger("change");
                            
                            // After size is selected, convert base unit quantity to product size unit for display
                            setTimeout(() => {
                                if (selectedProductSize) {
                                    const productSizeUnitId = selectedProductSize.measuringUnitId;
                                    
                                    // Get base unit and convert quantity for display
                                    fetch(`/Sales/GetAvailableStock?productId=${productId}`)
                                        .then(response => response.json())
                                        .then(data => {
                                            if (data.success && data.baseUnitId) {
                                                const productBaseUnitId = data.baseUnitId;
                                                
                                                if (productSizeUnitId == productBaseUnitId) {
                                                    // Same unit, use base unit quantity
                                                    document.getElementById('quantity').value = baseUnitQuantity.toFixed(3);
                                                } else {
                                                    // Convert base unit quantity to product size unit for display
                                                    fetch(`/Sales/ConvertUnitAndGetStock?productId=${productId}&fromUnitId=${productBaseUnitId}&toUnitId=${productSizeUnitId}&stockInBaseUnit=${baseUnitQuantity}`)
                                                        .then(response => response.json())
                                                        .then(conversionData => {
                                                            if (conversionData.success) {
                                                                const displayQty = conversionData.convertedStock;
                                                                document.getElementById('quantity').value = displayQty.toFixed(3);
                                                            } else {
                                                                // Fallback: use display quantity if available, otherwise base unit
                                                                document.getElementById('quantity').value = (displayQuantity || baseUnitQuantity).toFixed(3);
                                                            }
                                                        })
                                                        .catch(error => {
                                                            console.error('Error converting quantity for edit:', error);
                                                            document.getElementById('quantity').value = (displayQuantity || baseUnitQuantity).toFixed(3);
                                                        });
                                                }
                                            } else {
                                                // No base unit found, use display quantity or base unit
                                                document.getElementById('quantity').value = (displayQuantity || baseUnitQuantity).toFixed(3);
                                            }
                                        })
                                        .catch(error => {
                                            console.error('Error getting base unit for edit:', error);
                                            document.getElementById('quantity').value = (displayQuantity || baseUnitQuantity).toFixed(3);
                                        });
                                } else {
                                    // No product size selected, use display quantity or base unit
                                    document.getElementById('quantity').value = (displayQuantity || baseUnitQuantity).toFixed(3);
                                }
                            }, 200);
                        }
                    }

                    // Populate other fields (quantity will be set after conversion)
                    document.getElementById('unitPrice').value = unitPrice.toFixed(2);
                    document.getElementById('salePrice').value = salePrice.toFixed(2);
                    // Calculate item level discount (per unit discount) - use display quantity for calculation
                    const qtyForDiscount = displayQuantity || baseUnitQuantity;
                    const itemLevelDiscount = qtyForDiscount > 0 ? lineDiscountAmount / qtyForDiscount : 0;
                    document.getElementById('discountAmount').value = itemLevelDiscount.toFixed(2);

                    // Calculate payable amount (will be recalculated when quantity is set)
                    calculatePayableAmount();

                    // Remove the row from table (user will add it back with updated values)
                    row.remove();
                    updateTotals();

                    // Show success message
                    showSuccessMessage('Product loaded for editing. Update the values and click "Add to Sale" to save changes.');

                }, 500); // Wait 500ms for the product sizes to load

            } catch (error) {
                console.error('Error editing product from table:', error);
                showErrorMessage('Error loading product for editing. Please try again.');
            }
        }

        // Payment Method Dropdown Logic
        $(document).ready(function() {
            // Handle payment method change
            $('#paymentMethodSelect').on('change', function() {
                const paymentCombo = $("#paymentMethodSelect").data("kendoComboBox");
                const paymentMethod = paymentCombo ? paymentCombo.value() : null;
                const onlineAccountDiv = $('#onlineAccountDiv');
                const onlineAccountSelect = $('#onlineAccountSelect');
                const payNowField = $('#PayNow');

                // Clear validation styling
                $(this).removeClass('is-invalid');
                payNowField.removeClass('is-invalid');

                if (paymentMethod === 'Online') {
                    onlineAccountDiv.show();
                    loadOnlineAccounts();
                } else {
                    onlineAccountDiv.hide();
                    onlineAccountSelect.val('').trigger('change');
                }
                
                // Validate Pay Now amount for Cash and Online payments
                if (paymentMethod === 'Cash' || paymentMethod === 'Online') {
                    const payNowAmount = parseFloat(payNowField.val()) || 0;
                    if (payNowAmount <= 0) {
                        payNowField.addClass('is-invalid');
                        showErrorMessage('Pay Now amount must be greater than zero for Cash and Online payments.');
                    } else {
                        payNowField.removeClass('is-invalid');
                    }
                }
            });

            // Handle online account change
            $('#onlineAccountSelect').on('change', function() {
                // Clear validation styling
                $(this).removeClass('is-invalid');
            });
            
            // Handle Pay Now field change
            $('#PayNow').on('input change', function() {
                const paymentMethod = $('#paymentMethodSelect').val();
                const payNowAmount = parseFloat($(this).val()) || 0;
                
                // Clear validation styling
                $(this).removeClass('is-invalid');
                
                // Validate Pay Now amount for Cash and Online payments
                if (paymentMethod === 'Cash' || paymentMethod === 'Online') {
                    if (payNowAmount <= 0) {
                        $(this).addClass('is-invalid');
                        showErrorMessage('Pay Now amount must be greater than zero for Cash and Online payments.');
                    } else {
                        $(this).removeClass('is-invalid');
                    }
                }
            });

            // Load online accounts from PersonalPayments
            function loadOnlineAccounts() {
                $.ajax({
                    url: '/Sales/GetOnlineAccounts',
                    type: 'GET',
                    success: function(data) {
                        const select = $('#onlineAccountSelect');
                        select.empty();
                        select.append('<option value="">--Select Online Account--</option>');

                        if (data && data.length > 0) {
                            data.forEach(function(account) {
                                select.append(`<option value="${account.personalPaymentId}">${account.bankName} - ${account.accountNumber}</option>`);
                            });
                        }
                    },
                    error: function() {
                        console.error('Error loading online accounts');
                    }
                });
            }
        });
    </script>
}