@using IMS.DAL.PrimaryDBContext
@model StockMaster;

@* <div class="container mt-4"> *@
    <div class="card shadow-sm">
        <div class="card-body">
            <form asp-action="Create">
                <div class="card-header" style="background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%); color: white; border: none;">
                    <h2 class="mb-0">Add New Stock</h2>
                </div>
                <div class="card-body">
                    <div class="row row-cols-1 row-cols-md-2 row-cols-md-4 g-4 mt-2">
                        <div class="col">
                            <label asp-for="CategoryIdFk" class="form-label">Category:</label>
                            @Html.DropDownList("CategoryIdFk", ViewBag.Categories as IEnumerable<SelectListItem>, "<-- Select Category -->", new { @class = "form-control", @id = "CategoryIdFk" })
                            <span asp-validation-for="CategoryIdFk" class="text-danger"></span>
                        </div>
                        <div class="col">
                            <label asp-for="ProductIdFk" class="form-label">Product:</label>
                            @Html.DropDownList("ProductIdFk", ViewBag.Products as IEnumerable<SelectListItem>, "<-- Select Product -->", new { @class = "form-control", @id = "ProductIdFk" })
                            <span asp-validation-for="ProductIdFk" class="text-danger"></span>
                        </div>
                        <div class="col">
                            <label asp-for="TotalQuantity" class="form-label">New Stock Quantity:</label>
                            <input asp-for="TotalQuantity" class="form-control" type="number" step="0.001" />
                            <small class="form-text text-muted">Quantity of new stock being added</small>
                            <span asp-validation-for="TotalQuantity" class="text-danger"></span>
                        </div>
                        <div class="col">
                            <label asp-for="AvailableQuantity" class="form-label">Available Quantity:</label>
                            <input asp-for="AvailableQuantity" class="form-control" type="number" step="0.001" readonly />
                            <small class="form-text text-muted">Shows current available stock + new stock being added</small>
                        </div>
                      @*   <div class="col">
                            <label asp-for="UsedQuantity" class="form-label">Used Quantity:</label>
                            <input asp-for="UsedQuantity" class="form-control" type="number" step="1" readonly />
                            <small class="form-text text-muted">Read-only field</small>
                        </div> *@
                        <div class="col">
                            <label asp-for="Comment" class="form-label">Description:</label>
                            <textarea asp-for="Comment" class="form-control" rows="3"></textarea>
                            <span asp-validation-for="Comment" class="text-danger"></span>
                        </div>
                    </div>
                    <div class="mb-3" style="padding:inherit">
                        <button type="submit" class="btn btn-success">Create</button>
                        <a asp-action="Index" class="btn btn-secondary">Cancel</a>
                    </div>
                </div>
            </form>
        </div>
    </div>
@* </div> *@

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        $(document).ready(function() {
            // Handle category change event
            $('#CategoryIdFk').change(function() {
                var categoryId = $(this).val();
                var productDropdown = $('#ProductIdFk');
                
                // Clear existing products
                productDropdown.empty();
                productDropdown.append('<option value="">&lt;-- Select Product --&gt;</option>');
                
                if (categoryId && categoryId !== '') {
                    // Show loading state
                    productDropdown.prop('disabled', true);
                    
                    // Fetch products for selected category
                    $.ajax({
                        url: '@Url.Action("GetProductsByCategory", "Stock")',
                        type: 'GET',
                        data: { categoryId: categoryId },
                        success: function(data) {
                            $.each(data, function(index, item) {
                                productDropdown.append('<option value="' + item.value + '">' + item.text + '</option>');
                            });
                            productDropdown.prop('disabled', false);
                        },
                        error: function() {
                            alert('Error loading products for selected category.');
                            productDropdown.prop('disabled', false);
                        }
                    });
                } else {
                    productDropdown.prop('disabled', false);
                }
            });

            // Handle product selection to load existing stock
            $('#ProductIdFk').change(function() {
                var productId = $(this).val();
                if (productId && productId !== '') {
                    loadExistingStock(productId);
                } else {
                    // Clear available quantity if no product selected
                    $('#AvailableQuantity').val(0);
                }
            });

            // Auto-calculate available quantity when total quantity changes
            $('#TotalQuantity').on('input', function() {
                const newStockQty = parseFloat($(this).val()) || 0;
                const existingAvailable = parseFloat($('#AvailableQuantity').data('existing-available')) || 0;
                
                // New available = Existing available + New stock quantity
                const newAvailable = existingAvailable + newStockQty;
                $('#AvailableQuantity').val(newAvailable);
            });

            function loadExistingStock(productId) {
                $.ajax({
                    url: '@Url.Action("GetExistingStock", "Stock")',
                    type: 'GET',
                    data: { productId: productId },
                    success: function(data) {
                        if (data.success) {
                            // Store existing available quantity for calculation
                            $('#AvailableQuantity').data('existing-available', data.availableQuantity);
                            $('#AvailableQuantity').val(data.availableQuantity);
                            
                            // Update the label to show existing stock info
                            const label = $('label[for="AvailableQuantity"]');
                            label.html('Available Quantity: <small class="text-muted">(Current: ' + data.availableQuantity + ')</small>');
                        } else {
                            // No existing stock
                            $('#AvailableQuantity').data('existing-available', 0);
                            $('#AvailableQuantity').val(0);
                            
                            const label = $('label[for="AvailableQuantity"]');
                            label.html('Available Quantity: <small class="text-muted">(No existing stock)</small>');
                        }
                    },
                    error: function() {
                        console.error('Error loading existing stock');
                        $('#AvailableQuantity').data('existing-available', 0);
                        $('#AvailableQuantity').val(0);
                    }
                });
            }
        });
    </script>
}

