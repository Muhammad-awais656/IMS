@model VendorBillGenerationViewModel

@{
    ViewData["Title"] = "Generate Vendor Bill";
}

<link href="~/css/dist/addsales.css" rel="stylesheet" />
@* <div class="container-fluid"> *@
<div class="card shadow-sm">
    <div class="card-header bg-primary text-white">
        <h2 class="mb-0 text-center">
            <i class="fa-solid fa-file-invoice me-2"></i>
            @if (ViewBag.IsEdit == true)
            {
                <text>Edit Vendor Bill</text>
            }
            else
            {
                <text>Generate Vendor Bill</text>
            }
        </h2>
    </div>

    <div class="card-body">
        <form asp-action="@(ViewBag.IsEdit == true ? "Edit" : "GenerateBill")" asp-controller="VendorBills" method="post" id="generateBillForm">
            @Html.AntiForgeryToken()
            <!-- Hidden field to track which button was clicked -->
            <input type="hidden" id="actionType" name="actionType" value="" />
            <!-- Hidden field for BillId when editing -->
            <input type="hidden" asp-for="BillId" id="billId" />

            <!-- Product Selection Section -->
            <div class="row mb-4">
                <div class="col-12">
                    <h5 class="text-primary mb-3">
                        <i class="fa-solid fa-box me-2"></i>Product Selection
                    </h5>
                </div>
                <div class="col-md-3">
                    <label for="productSelect" class="form-label">Product:</label>
                    <input id="productSelect" name="ProductId" style="width: 100%;" />
                </div>
                <div class="col-md-3">
                    <label for="productSizeSelect" class="form-label">Product Size:</label>
                    <input id="productSizeSelect" name="ProductSizeId" style="width: 100%;" />
                </div>
                <div class="col-md-2">
                    <label for="quantity" class="form-label">Quantity:</label>
                    <input type="number" id="quantity" class="form-control" value="1" min="0" step="0.001" />
                </div>
                <div class="col-md-2">
                    <label for="unitPrice" class="form-label">Unit Price:</label>
                    <input type="number" id="unitPrice" class="form-control" value="0" step="0.01" readonly />
                </div>
                <div class="col-md-2">
                    <label for="purchasePrice" class="form-label">Purchase Price:</label>
                    <input type="number" id="purchasePrice" class="form-control" value="0" step="0.01" />
                </div>
            </div>

            <div class="row mb-4">
                <div class="col-md-3">
                    <label for="discountAmount" class="form-label">Line Discount:</label>
                    <input type="number" id="discountAmount" class="form-control" value="0" step="0.01" />
                </div>
                <div class="col-md-3">
                    <label for="payableAmount" class="form-label">Payable Amount:</label>
                    <input type="number" id="payableAmount" class="form-control" value="0" step="0.01" readonly />
                </div>
                <div class="col-md-6 d-flex align-items-end">
                    <button type="button" class="btn btn-primary me-2" id="addToTable" title="Add product to bill (Ctrl+Enter)">
                        <i class="fa-solid fa-plus me-1"></i>Add to Bill
                    </button>
                    <button type="button" class="btn btn-outline-secondary" id="resetFields" title="Reset product fields (Escape)">
                        <i class="fa-solid fa-rotate-left me-1"></i>Reset Product
                    </button>
                </div>
            </div>

            <!-- Bill Items Table -->
            <div class="row mb-4">
                <div class="col-12">
                    <h5 class="text-primary mb-3">
                        <i class="fa-solid fa-list me-2"></i>Bill Items
                    </h5>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="billDetailsTable">
                            <thead class="table-dark">
                                <tr>
                                    <th>Measuring Unit</th>
                                    <th>Product</th>
                                    <th>Item Level Discount</th>
                                    <th>Unit Price</th>
                                    <th>Purchase Price</th>
                                    <th>Qty</th>
                                    <th>Total Discount</th>
                                    <th>Payable</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="billDetailsBody">
                                <!-- Bill items will be added here dynamically -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

          
            <!-- Vendor Selection Section -->
            <div class="row mb-4">
                <div class="col-12">
                    <h5 class="text-primary mb-3">
                        <i class="fa-solid fa-credit-card me-2"></i>Purchase Information
                    </h5>
                </div>
                <div class="col-md-3">
                    <label for="vendorSelect" class="form-label">Vendor:</label>
                    <input id="vendorSelect" name="VendorId" asp-for="VendorId" style="width: 100%;" />
                </div>
                <div class="col-md-3">
                    <label for="CustomerId" class="form-label">Customer:</label>
                    <input id="customerSelect" name="CustomerId" asp-for="CustomerId" style="width: 100%;" />

                </div>

                <div class="col-md-3">
                    <label for="billNumber" class="form-label">Bill Number:</label>
                    <input type="number" id="billNumber" asp-for="BillNumber" class="form-control" readonly />
                </div>
                <div class="col-md-3">
                    <label for="billDate" class="form-label">Bill Date:</label>
                    <input type="date" id="billDate" asp-for="BillDate" class="form-control" />
                </div>

            </div>
          
            <!-- Payment Section -->
            <div class="row mb-4">
              @*   <div class="col-12">
                    <h5 class="text-primary mb-3">
                        <i class="fa-solid fa-credit-card me-2"></i>Payment Information
                    </h5>
                </div> *@
                <div class="col-md-3">
                    <label for="totalAmount" class="form-label">Total Amount:</label>
                    <input type="number" id="totalAmount" asp-for="TotalAmount" class="form-control" readonly />
                </div>
                <div class="col-md-3">
                    <label for="discountAmountTotal" class="form-label">Total Discount:</label>
                    <input type="number" id="discountAmountTotal" asp-for="DiscountAmount" class="form-control" step="0.01" />
                </div>
                <div class="col-md-3">
                    <label for="payNow" class="form-label">Pay Now:</label>
                    <input type="number" id="payNow" asp-for="PayNow" class="form-control" step="0.01" />
                </div>
                <div class="col-md-3">
                    <label for="dueAmount" class="form-label">Due Amount:</label>
                    <input type="number" id="dueAmount" asp-for="DueAmount" class="form-control" readonly />
                </div>
            </div>

            <!-- Payment Method Section -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <label for="paymentMethod" class="form-label">Payment Method:</label>
                    <input id="paymentMethod" name="PaymentMethod" asp-for="PaymentMethod" style="width: 100%;" />
                </div>
                <div class="col-md-3" id="onlineAccountSection" style="display: none;">
                    <label for="onlineAccountSelect" class="form-label">Online Account:</label>
                    <input id="onlineAccountSelect" name="OnlineAccountId" style="width: 100%;" />
                </div>
                <div class="col-md-3" id="accountBalanceSection" style="display: none;">
                    <label for="accountBalance" class="form-label">Account Balance:</label>
                    <input type="number" id="accountBalance" class="form-control" readonly />
                </div>
                <div class="col-md-3" id="billAmountSection" style="display: none;">
                    <label for="billAmount" class="form-label">Bill Amount:</label>
                    <input type="number" id="billAmount" class="form-control" readonly />
                </div>
                <div class="col-md-3">
                    <label for="previousDue" class="form-label">Previous Due:</label>
                    <input type="number" id="previousDue" asp-for="PreviousDue" class="form-control" readonly />
                </div>
                <div class="col-md-3">
                    <label for="receivedAmount" class="form-label">Paid Amount:</label>
                    <input type="number" id="receivedAmount" asp-for="PaidAmount" class="form-control" readonly />
                </div>
            </div>
            <div class="row mb-4">


                <div class="col-md-3">
                    <label for="description" class="form-label">Description:</label>
                    <textarea type="text" id="description" asp-for="Description" class="form-control" placeholder="Bill description" ></textarea>
                </div>
               
            </div>

            <!-- Action Buttons -->
            <div class="row">
                <div class="col-12 text-center">
                    <button type="submit" class="btn btn-success me-2" id="saveButton">
                        <i class="fa-solid fa-save me-1"></i>
                        @if (ViewBag.IsEdit == true)
                        {
                            <text>Update Bill</text>
                        }
                        else
                        {
                            <text>Save Bill</text>
                        }
                    </button>
                    <button type="submit" class="btn btn-primary me-2" id="saveAndPrintButton">
                        <i class="fa-solid fa-print me-1"></i>
                        @if (ViewBag.IsEdit == true)
                        {
                            <text>Update & Print</text>
                        }
                        else
                        {
                            <text>Save & Print</text>
                        }
                    </button>
                    <a href="@Url.Action("Index")" class="btn btn-secondary">
                        <i class="fa-solid fa-arrow-left me-1"></i>Back to List
                    </a>
                </div>
            </div>
        </form>
    </div>
</div>
@* </div> *@

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    @* <script src="~/js/vendor-bill-generation.js"></script> *@
    <script>
        // Pass edit mode and bill details data to JavaScript
        var isEditMode = '@(ViewBag.IsEdit == true ? "true" : "false")';
        var billDetailsData = @Html.Raw(Json.Serialize(Model?.BillDetails ?? new List<VendorBillDetailViewModel>()));
        var paymentMethodValue = '@(Model?.PaymentMethod ?? "")';
        var onlineAccountIdValue = @(Model?.OnlineAccountId?.ToString() ?? "null");

        // Set payment method value as data attribute
        @if (Model != null && !string.IsNullOrEmpty(Model.PaymentMethod))
        {
                <text>$("#paymentMethod").attr('data-value', '@Model.PaymentMethod');</text>
        }

        @if (Model != null && Model.OnlineAccountId.HasValue)
        {
                <text>$("#onlineAccountSelect").attr('data-value', '@Model.OnlineAccountId.Value');</text>
        }

        console.log('Script initialization:', {
            isEditMode: isEditMode,
            billDetailsDataLength: billDetailsData ? billDetailsData.length : 'undefined',
            billDetailsData: billDetailsData,
            paymentMethodValue: paymentMethodValue,
            onlineAccountIdValue: onlineAccountIdValue
        });

        $(document).ready(function() {
            console.log("=== GenerateBill.cshtml - Document Ready ===");
            console.log("vendor-bill-generation.js should be loaded");

            // Initialize Kendo UI components
            initializeVendorBillGeneration();

            // Verify functions are available
            console.log("updateStockDisplay function available:", typeof updateStockDisplay !== 'undefined');
            console.log("onProductSizeChange function available:", typeof onProductSizeChange !== 'undefined');
            console.log("loadAvailableStockInProductSizeUnit function available:", typeof loadAvailableStockInProductSizeUnit !== 'undefined');
        });
                // Vendor Bill Generation JavaScript
        let billDetails = [];
        let currentProductId = null;
        let currentProductRangeId = null;
        let editingIndex = -1;
        let selectedProductSize = null;
        let currentAvailableStock = 0; // Variable to store current available stock in selected unit
        let isPopulatingEditForm = false; // Flag to prevent multiple simultaneous calls

        function initializeVendorBillGeneration() {
            // Initialize Kendo UI components
            initializeVendorComboBox();
            initializeProductComboBox();
            initializeProductSizeComboBox();
            initializeOnlineAccountComboBox();
            initializePaymentMethodComboBox();

            // Set up event handlers
            setupEventHandlers();

            // Initialize form
            initializeForm();

            // Check if we're in edit mode and populate form
            // isEditMode is passed as a string "true" or "false"
            if (typeof isEditMode !== 'undefined' && (isEditMode === 'true' || isEditMode === true)) {
                console.log('Edit mode detected, populating form...');
                // Add a small delay to ensure all data is loaded
                setTimeout(function() {
                    populateEditForm();
                }, 100);
            }
        }

        function initializeVendorComboBox() {
            var initialValue = $("#vendorSelect").val();

            $("#vendorSelect").kendoComboBox({
                placeholder: "Select vendor...",
                dataTextField: "text",
                dataValueField: "value",
                filter: "contains",
                minLength: 1,
                value: initialValue, // Set initial value if exists
                dataSource: {
                    transport: {
                        read: {
                            url: "/VendorBills/GetVendors",
                            dataType: "json"
                        }
                    },
                    schema: {
                        data: "data"
                    }
                },
                change: function(e) {
                    if (this.value()) {
                        // loadVendorData(this.value());
                            // Clear vendor when customer is selected
                    const customerCombo = $("#customerSelect").data("kendoComboBox");
                    if (customerCombo && this.value()) {
                        customerCombo.value("");
                    }

                        loadVendorPreviousDueAmount();
                        // Clear validation styling when vendor is selected
                        $("#vendorSelect").removeClass('is-invalid');
                    }
                }
            });

            // If we have an initial value, load vendor data
            if (initialValue) {
                setTimeout(function() {
                       loadVendorPreviousDueAmount();
                }, 500);
            }
        }

            // Customer Selection Combobox
            $("#customerSelect").kendoComboBox({
                dataSource: {
                    transport: {
                        read: {
                            url: "/Sales/GetCustomers",
                            dataType: "json"
                        }
                    }
                },
                dataTextField: "text",
                dataValueField: "value",
                placeholder: "-- Select Customer --",
                filter: "contains",
                suggest: true,
                minLength: 1,
                change: function() {
                    // Clear vendor when customer is selected
                    const vendorCombo = $("#vendorSelect").data("kendoComboBox");
                    if (vendorCombo && this.value()) {
                        vendorCombo.value("");
                    }
                    loadPreviousDueAmount();
                }
            });
        function loadPreviousDueAmount() {
                   const customerCombo = $("#customerSelect").data("kendoComboBox");
                   const customerId = customerCombo ? customerCombo.value() : null;
                   const previousDueInput = document.getElementById('previousDue');

                   if (customerId) {
                       // Show loading state
                       previousDueInput.value = 'Loading...';
                       previousDueInput.style.backgroundColor = '#f8f9fa';
                       previousDueInput.style.color = '#6c757d';

                       // AJAX call to fetch previous due amount
                       fetch(`/Sales/GetPreviousDueAmount?customerId=${customerId}`)
                           .then(response => response.json())
                           .then(data => {
                               if (data.success) {
                                   const amount = parseFloat(data.previousDueAmount);
                                   previousDueInput.value = amount.toFixed(2);

                                   // Visual feedback based on amount
                                   if (amount > 0) {
                                       previousDueInput.style.backgroundColor = '#fff3cd';
                                       previousDueInput.style.color = '#856404';
                                       showSuccessMessage(`Previous due amount loaded: $${amount.toFixed(2)}`);
                                   } else {
                                       previousDueInput.style.backgroundColor = '#d1edff';
                                       previousDueInput.style.color = '#0c5460';
                                       showSuccessMessage('No previous due amount for this customer');
                                   }
                               } else {
                                   previousDueInput.value = '0.00';
                                   previousDueInput.style.backgroundColor = '#f8d7da';
                                   previousDueInput.style.color = '#721c24';
                                   showErrorMessage(data.message || 'Error loading previous due amount');
                               }
                           })
                           .catch(error => {
                               console.error('Error loading previous due amount:', error);
                               previousDueInput.value = '0.00';
                               previousDueInput.style.backgroundColor = '#f8d7da';
                               previousDueInput.style.color = '#721c24';
                               showErrorMessage('Error loading previous due amount');
                           })
                           .finally(() => {
                               // Reset to normal state after a delay
                               setTimeout(() => {
                                   previousDueInput.style.backgroundColor = '';
                                   previousDueInput.style.color = '';
                               }, 2000);

                               // Update totals after loading previous due
                               updateTotals();
                           });
                   } else {
                       // Clear previous due when no customer selected
                       previousDueInput.value = '0.00';
                       previousDueInput.style.backgroundColor = '';
                       previousDueInput.style.color = '';
                       updateTotals();
                   }
               }




        function initializeProductComboBox() {
            $("#productSelect").kendoComboBox({
                placeholder: "Select product...",
                dataTextField: "text",
                dataValueField: "value",
                filter: "contains",
                suggest: false,
                minLength: 1,
                dataSource: {
                    transport: {
                        read: {
                            // Use VendorBills endpoint for products
                            url: "/VendorBills/GetProducts",
                            dataType: "json"
                        }
                    },
                    schema: {
                        data: "data"
                    }
                },
                change: function(e) {
                    if (this.value()) {
                        currentProductId = this.value();
                        loadProductSizes(this.value());
                        // Don't load stock here - it will be loaded when product size is selected
                        // loadProductStock(this.value()); // Removed - stock loads on product size selection
                    } else {
                        // Clear stock display when product is deselected
                        currentAvailableStock = 0;
                        updateStockDisplay();
                    }
                }
            });
        }

        function initializeProductSizeComboBox() {
            $("#productSizeSelect").kendoComboBox({
                placeholder: "Select product size...",
                dataTextField: "text",
                dataValueField: "value",
                filter: "contains",
                minLength: 1,
                dataSource: {
                    data: []
                },
                change: function(e) {
                    console.log("Product size combo change event fired");
                    // Add small delay to ensure dataItem is available
                    setTimeout(function() {
                        onProductSizeChange();
                    }, 100);
                },
                select: function(e) {
                    console.log("Product size combo select event fired");
                    // Add small delay to ensure dataItem is available
                    setTimeout(function() {
                        onProductSizeChange();
                    }, 100);
                }
            });
        }

        function initializePaymentMethodComboBox() {
            $("#paymentMethod").kendoDropDownList({
                dataSource: [
                    { text: "Cash", value: "Cash" },
                    { text: "Online", value: "Online" },
                    { text: "Pay Later", value: "PayLater" }
                ],
                dataTextField: "text",
                dataValueField: "value",
                value: "Cash",
                change: function() {
                    var selectedValue = this.value();
                    if (selectedValue === "Online") {
                        $("#onlineAccountSection").show();
                        $("#accountBalanceSection").show();
                        $("#billAmountSection").show();
                    } else {
                        $("#onlineAccountSection").hide();
                        $("#accountBalanceSection").hide();
                        $("#billAmountSection").hide();
                    }
                }
            });
        }

        function initializeOnlineAccountComboBox() {
            $("#onlineAccountSelect").kendoComboBox({
                placeholder: "Select online account...",
                dataTextField: "text",
                dataValueField: "value",
                filter: "contains",
                minLength: 1,
                enabled: false, // Start disabled until Online payment method is selected
                dataSource: {
                    transport: {
                        read: {
                            url: "/VendorBills/GetOnlineAccounts",
                            dataType: "json"
                        }
                    },
                    schema: {
                        data: "data"
                    }
                }
            });
        }

        function setupEventHandlers() {
            // Quantity change
            $("#quantity").on("input", calculatePayableAmount);

            // Unit price change
            $("#unitPrice").on("input", calculatePayableAmount);

            // Purchase price change
            $("#purchasePrice").on("input", calculatePayableAmount);

            // Discount amount change
            $("#discountAmount").on("input", calculatePayableAmount);

            // Pay now change
            $("#payNow").on("input", function() {
                calculateDueAmount();
                validateAccountBalance();
            });

            // Online account change
            $("#onlineAccountSelect").on("change", function() {
                // Clear validation styling
                $(this).removeClass('is-invalid');

                // Load account balance when account is selected
                var accountCombo = $(this).data("kendoComboBox");
                var accountId = accountCombo ? accountCombo.value() : null;

                if (accountId) {
                    loadAccountBalance(accountId);
                } else {
                    $("#accountBalance").val("");
                    $("#billAmount").val("");
                }
            });

            // Total discount change
            $("#discountAmountTotal").on("input", calculateTotals);

            // Payment method change
            $("#paymentMethod").on("change", function() {
                var paymentMethod = $(this).val();
                if (paymentMethod === "Online") {
                    $("#onlineAccountSection").show();
                    $("#accountBalanceSection").show();
                    $("#billAmountSection").show();
                    // Load online accounts when Online is selected
                    loadOnlineAccounts();
                } else {
                    $("#onlineAccountSection").hide();
                    $("#accountBalanceSection").hide();
                    $("#billAmountSection").hide();
                }

                // Handle Pay Later option
                if (paymentMethod === "PayLater") {
                    $("#payNow").val(0).prop("disabled", true);
                } else {
                    $("#payNow").prop("disabled", false);
                }

                // Clear validation styling
                $(this).removeClass('is-invalid');
                $("#payNow").removeClass('is-invalid');
                $("#onlineAccountSelect").removeClass('is-invalid');

                calculateDueAmount();
            });

            // Add to table button
            $("#addToTable").on("click", addProductToTable);

            // Reset fields button
            $("#resetFields").on("click", resetProductFields);

            // Save button
            $("#saveButton").on("click", function() {
                $("#actionType").val("save");
            });

            // Save and print button
            $("#saveAndPrintButton").on("click", function() {
                $("#actionType").val("saveAndPrint");
            });

            // Keyboard shortcuts
            $(document).on("keydown", function(e) {
                if (e.ctrlKey && e.key === "Enter") {
                    e.preventDefault();
                    addProductToTable();
                } else if (e.key === "Escape") {
                    e.preventDefault();
                    resetProductFields();
                }
            });

            // Delegate edit/remove clicks on table
            $(document).on("click", ".edit-row", function() {
                const index = $(this).data("index");
                if (index != null && billDetails[index]) {
                    const item = billDetails[index];
                    editingIndex = index;

                    // Store base unit quantity before removing
                    const baseUnitQuantity = item.baseUnitQuantity || item.quantity || 0;

                    // Remove the item from the table and array
                    billDetails.splice(index, 1);
                    updateBillDetailsTable();
                    calculateTotals();

                    // Restore stock when editing (removing from table temporarily)
                    updateAvailableStockAfterRemove(baseUnitQuantity);

                    // Populate the form fields
                    const productCb = $("#productSelect").data("kendoComboBox");
                    const sizeCb = $("#productSizeSelect").data("kendoComboBox");
                    productCb.value(item.productId);
                    currentProductId = item.productId;
                    loadProductSizes(item.productId);
                    setTimeout(function(){
                        sizeCb.value(item.productRangeId);

                        // Get the selected size item to populate selectedProductSize
                        const sizeData = sizeCb.dataSource.data();
                        const selectedSize = sizeData.find(s => (s.value == item.productRangeId || s.productRangeId == item.productRangeId));

                        if (selectedSize) {
                            selectedProductSize = {
                                productRangeId: selectedSize.value || selectedSize.productRangeId,
                                measuringUnitId: selectedSize.measuringUnitId,
                                rangeFrom: selectedSize.rangeFrom,
                                rangeTo: selectedSize.rangeTo,
                                unitPrice: selectedSize.unitPrice,
                                measuringUnitName: selectedSize.measuringUnitName || "",
                                measuringUnitAbbreviation: selectedSize.measuringUnitAbbreviation || item.measuringUnitAbbreviation || "N/A"
                            };

                            // Convert base unit quantity to product size unit for display
                            if (selectedProductSize.measuringUnitId && baseUnitQuantity !== item.quantity) {
                                fetch(`/VendorBills/GetAvailableStock?productId=${item.productId}`)
                                    .then(response => response.json())
                                    .then(data => {
                                        if (data.success && data.baseUnitId) {
                                            const productBaseUnitId = data.baseUnitId;
                                            const productSizeUnitId = selectedProductSize.measuringUnitId;

                                            if (productSizeUnitId == productBaseUnitId) {
                                                // Same unit, use base unit quantity
                                                $("#quantity").val(parseFloat(baseUnitQuantity).toFixed(3));
                                            } else {
                                                // Convert base unit quantity to product size unit for display
                                                fetch(`/VendorBills/ConvertUnitAndGetStock?productId=${item.productId}&fromUnitId=${productBaseUnitId}&toUnitId=${productSizeUnitId}&stockInBaseUnit=${baseUnitQuantity}`)
                                                    .then(response => response.json())
                                                    .then(conversionData => {
                                                        if (conversionData.success) {
                                                            const displayQty = conversionData.convertedStock;
                                                            $("#quantity").val(displayQty.toFixed(3));
                                                        } else {
                                                            // Fallback: use display quantity if available, otherwise base unit
                                                            $("#quantity").val((item.quantity || baseUnitQuantity).toFixed(3));
                                                        }
                                                    })
                                                    .catch(error => {
                                                        console.error('Error converting quantity for edit:', error);
                                                        $("#quantity").val((item.quantity || baseUnitQuantity).toFixed(3));
                                                    });
                                            }
                                        } else {
                                            // No base unit found, use display quantity or base unit
                                            $("#quantity").val((item.quantity || baseUnitQuantity).toFixed(3));
                                        }
                                    })
                                    .catch(error => {
                                        console.error('Error getting base unit for edit:', error);
                                        $("#quantity").val((item.quantity || baseUnitQuantity).toFixed(3));
                                    });
                            } else {
                                // Use display quantity or base unit
                                $("#quantity").val((item.quantity || baseUnitQuantity).toFixed(3));
                            }
                        } else {
                            // Fallback if size not found
                            selectedProductSize = {
                                productRangeId: item.productRangeId,
                                measuringUnitId: item.measuringUnitId || null,
                                rangeFrom: item.rangeFrom || null,
                                rangeTo: item.rangeTo || null,
                                unitPrice: item.unitPrice,
                                measuringUnitName: item.measuringUnitName || "",
                                measuringUnitAbbreviation: item.measuringUnitAbbreviation || item.productSize || "N/A"
                            };
                            $("#quantity").val((item.quantity || baseUnitQuantity).toFixed(3));
                        }

                        console.log("Selected product size set from edit:", selectedProductSize);

                        // Load stock in product size unit
                        if (selectedProductSize.measuringUnitId) {
                            loadAvailableStockInProductSizeUnit(item.productId, selectedProductSize.measuringUnitId);
                        }
                    }, 500);

                    $("#unitPrice").val(item.unitPrice);
                    $("#purchasePrice").val(item.purchasePrice);
                    $("#discountAmount").val(item.lineDiscountAmount / (item.quantity || 1)); // Convert back to per-unit discount
                    $("#payableAmount").val(item.payableAmount);
                    $("#addToTable").text("Update Item");
                }
            });

            $(document).on("click", ".remove-row", function() {
                const index = $(this).data("index");
                if (index != null && billDetails[index]) {
                    const item = billDetails[index];
                    const baseUnitQuantity = item.baseUnitQuantity || item.quantity || 0;

                    billDetails.splice(index, 1);
                    updateBillDetailsTable();
                    calculateTotals();

                    // Update available stock after removing item (for vendor bills, removing decreases stock)
                    updateAvailableStockAfterRemove(baseUnitQuantity);
                }
            });

        }

        function initializeForm() {
            // Only load next bill number if not in edit mode
            if (typeof isEditMode === 'undefined' || (isEditMode !== 'true' && isEditMode !== true)) {
                // Set today's date
                $("#billDate").val(new Date().toISOString().split('T')[0]);

                // Load next bill number
                loadNextBillNumber();
            }
        }

        function loadVendorData(vendorId) {
            // Load previous due amount
            $.get("/VendorBills/GetPreviousDueAmount", { vendorId: vendorId })
                .done(function(data) {
                    if (data.success) {
                        $("#previousDue").val(data.previousDueAmount);
                    }
                })
                .fail(function() {
                    console.error("Error loading vendor data");
                });

            // Load next bill number for the selected vendor
            loadNextBillNumber(vendorId);
        }

        function loadVendorPreviousDueAmount() {
                    const vendorCombo = $("#vendorSelect").data("kendoComboBox");
                    const vendorId = vendorCombo ? vendorCombo.value() : null;
                    const previousDueInput = document.getElementById('previousDue');

                    if (vendorId) {
                        // Show loading state
                        previousDueInput.value = 'Loading...';
                        previousDueInput.style.backgroundColor = '#f8f9fa';
                        previousDueInput.style.color = '#6c757d';

                        // AJAX call to fetch previous due amount for vendor
                        fetch(`/Sales/GetVendorPreviousDueAmount?vendorId=${vendorId}`)
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    const amount = parseFloat(data.previousDueAmount);
                                    previousDueInput.value = amount.toFixed(2);

                                    // Visual feedback based on amount
                                    if (amount > 0) {
                                        previousDueInput.style.backgroundColor = '#fff3cd';
                                        previousDueInput.style.color = '#856404';
                                        showSuccessMessage(`Previous due amount loaded: $${amount.toFixed(2)}`);
                                    } else {
                                        previousDueInput.style.backgroundColor = '#d1edff';
                                        previousDueInput.style.color = '#0c5460';
                                        showSuccessMessage('No previous due amount for this vendor');
                                    }
                                } else {
                                    previousDueInput.value = '0.00';
                                    previousDueInput.style.backgroundColor = '#f8d7da';
                                    previousDueInput.style.color = '#721c24';
                                    showErrorMessage(data.message || 'Error loading previous due amount');
                                }
                            })
                            .catch(error => {
                                console.error('Error loading vendor previous due amount:', error);
                                previousDueInput.value = '0.00';
                                previousDueInput.style.backgroundColor = '#f8d7da';
                                previousDueInput.style.color = '#721c24';
                                showErrorMessage('Error loading previous due amount');
                            })
                            .finally(() => {
                                // Reset to normal state after a delay
                                setTimeout(() => {
                                    previousDueInput.style.backgroundColor = '';
                                    previousDueInput.style.color = '';
                                }, 2000);

                                // Update totals after loading previous due
                                updateTotals();
                            });
                    } else {
                        // Clear previous due when no vendor selected
                        previousDueInput.value = '0.00';
                        previousDueInput.style.backgroundColor = '';
                        previousDueInput.style.color = '';
                        updateTotals();
                    }
                         // Load next bill number for the selected vendor
            loadNextBillNumber(vendorId);
                }

        function loadProductSizes(productId) {
            // Use VendorBills endpoint for product sizes
            $.get("/VendorBills/GetProductSizes", { productId: productId })
                .done(function(data) {
                    var productSizeComboBox = $("#productSizeSelect").data("kendoComboBox");
                    // Ensure proper Kendo DataSource binding
                    var ds = new kendo.data.DataSource({ data: data });
                    productSizeComboBox.setDataSource(ds);
                    productSizeComboBox.refresh();
                })
                .fail(function() {
                    console.error("Error loading product sizes");
                });
        }

        function onProductSizeChange() {
            console.log("=== onProductSizeChange function called ===");
            var productSizeComboBox = $("#productSizeSelect").data("kendoComboBox");
            var selectedValue = productSizeComboBox ? productSizeComboBox.value() : null;
            var selectedItem = productSizeComboBox ? productSizeComboBox.dataItem() : null;

            console.log("Selected value:", selectedValue);
            console.log("Selected item:", selectedItem);
            console.log("Selected item keys:", selectedItem ? Object.keys(selectedItem) : "null");
            console.log("Selected item full data:", JSON.stringify(selectedItem, null, 2));

            if (selectedValue && selectedItem) {
                // Store the selected product size data globally - match Sales pattern exactly
                selectedProductSize = {
                    productRangeId: selectedItem.value || selectedItem.productRangeId,
                    measuringUnitId: selectedItem.measuringUnitId,
                    rangeFrom: selectedItem.rangeFrom,
                    rangeTo: selectedItem.rangeTo,
                    unitPrice: selectedItem.unitPrice,
                    measuringUnitName: selectedItem.measuringUnitName,
                    measuringUnitAbbreviation: selectedItem.measuringUnitAbbreviation
                };

                console.log("Selected product size stored:", selectedProductSize);
                console.log("Measuring unit ID:", selectedProductSize.measuringUnitId);
                console.log("Measuring unit abbreviation:", selectedProductSize.measuringUnitAbbreviation);

                // Populate unit price
                $("#unitPrice").val(parseFloat(selectedProductSize.unitPrice || 0).toFixed(2));
                $("#purchasePrice").val(parseFloat(selectedProductSize.unitPrice || 0).toFixed(2)); // Default to unit price

                // Update current product range ID
                currentProductRangeId = selectedValue;

                // Load and display available stock in the product size's unit
                // Get product ID directly from product combo box (like Add Sale screen)
                const productCombo = $("#productSelect").data("kendoComboBox");
                const productId = productCombo ? productCombo.value() : null;

                console.log("Product combo box:", productCombo);
                console.log("Product ID from combo:", productId);
                console.log("Measuring Unit ID from selected item:", selectedItem.measuringUnitId);

                if (productId && selectedItem.measuringUnitId) {
                    console.log("Calling loadAvailableStockInProductSizeUnit with:", {
                        productId: productId,
                        measuringUnitId: selectedItem.measuringUnitId
                    });
                    loadAvailableStockInProductSizeUnit(productId, selectedItem.measuringUnitId);
                } else {
                    console.warn("Cannot load stock - missing productId or measuringUnitId", {
                        productId: productId,
                        measuringUnitId: selectedItem.measuringUnitId,
                        hasProductCombo: !!productCombo,
                        hasSelectedItem: !!selectedItem
                    });
                    // Reset stock display if we can't load
                    currentAvailableStock = 0;
                    updateStockDisplay();
                }

                calculatePayableAmount();
            } else {
                console.warn("No selected item found in product size combo");
                selectedProductSize = null;
                currentProductRangeId = null;
                currentAvailableStock = 0;
                updateStockDisplay();
            }
        }

        // Function to load available stock in product size's unit
        function loadAvailableStockInProductSizeUnit(productId, productSizeUnitId) {
            console.log("=== loadAvailableStockInProductSizeUnit called ===", {
                productId: productId,
                productSizeUnitId: productSizeUnitId
            });

            if (!productId || !productSizeUnitId) {
                console.error("Missing required data for loading stock:", {
                    productId: productId,
                    productSizeUnitId: productSizeUnitId
                });
                currentAvailableStock = 0;
                updateStockDisplay();
                return;
            }

            console.log("Fetching stock from /VendorBills/GetAvailableStock?productId=" + productId);

            // Get stock in base unit along with base unit ID
            fetch(`/VendorBills/GetAvailableStock?productId=${productId}`)
                .then(response => {
                    console.log("GetAvailableStock response status:", response.status);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log("GetAvailableStock response data:", data);
                    if (data.success) {
                        const stockInBaseUnit = data.availableQuantity;
                        const productBaseUnitId = data.baseUnitId;

                        console.log("Stock data received:", {
                            stockInBaseUnit: stockInBaseUnit,
                            productBaseUnitId: productBaseUnitId,
                            productSizeUnitId: productSizeUnitId
                        });

                        // If product size unit is same as base unit, no conversion needed
                        if (!productBaseUnitId || productSizeUnitId == productBaseUnitId) {
                            console.log("No conversion needed - same unit");
                            currentAvailableStock = stockInBaseUnit;
                            updateStockDisplay();
                        } else {
                            // Convert stock from base unit to product size unit
                            console.log('Converting stock:', {
                                stockInBaseUnit: stockInBaseUnit,
                                fromUnitId: productBaseUnitId,
                                toUnitId: productSizeUnitId
                            });

                            const conversionUrl = `/VendorBills/ConvertUnitAndGetStock?productId=${productId}&fromUnitId=${productBaseUnitId}&toUnitId=${productSizeUnitId}&stockInBaseUnit=${stockInBaseUnit}`;
                            console.log("Conversion URL:", conversionUrl);

                            fetch(conversionUrl)
                                .then(response => {
                                    console.log("ConvertUnitAndGetStock response status:", response.status);
                                    if (!response.ok) {
                                        throw new Error(`HTTP error! status: ${response.status}`);
                                    }
                                    return response.json();
                                })
                                .then(conversionData => {
                                    console.log("ConvertUnitAndGetStock response data:", conversionData);
                                    if (conversionData.success) {
                                        currentAvailableStock = conversionData.convertedStock;
                                        console.log('Stock converted successfully:', {
                                            baseStock: stockInBaseUnit,
                                            baseUnitId: productBaseUnitId,
                                            productSizeUnitId: productSizeUnitId,
                                            convertedStock: conversionData.convertedStock,
                                            conversionFactor: conversionData.conversionFactor
                                        });
                                        updateStockDisplay();
                                    } else {
                                        console.warn('Conversion failed, using base unit stock');
                                        // Fallback to base unit if conversion fails
                                        currentAvailableStock = stockInBaseUnit;
                                        updateStockDisplay();
                                    }
                                })
                                .catch(error => {
                                    console.error('Error converting stock:', error);
                                    currentAvailableStock = stockInBaseUnit;
                                    updateStockDisplay();
                                });
                        }
                    } else {
                        console.warn("GetAvailableStock returned success=false:", data);
                        currentAvailableStock = 0;
                        updateStockDisplay();
                    }
                })
                .catch(error => {
                    console.error('Error loading available stock:', error);
                    currentAvailableStock = 0;
                    updateStockDisplay();
                });
        }

        function updateStockDisplay() {
            console.log("=== updateStockDisplay called ===", {
                currentAvailableStock: currentAvailableStock,
                selectedProductSize: selectedProductSize
            });

            const quantityInput = document.getElementById('quantity');
            if (!quantityInput) {
                console.error('Quantity input element not found');
                return;
            }

            // Use full decimal value for display, but allow decimal input
            const maxQuantity = currentAvailableStock;

            // Update max attribute with full decimal value
            quantityInput.setAttribute('max', maxQuantity);

            // Update placeholder to show available stock with full precision
            quantityInput.setAttribute('placeholder', `Max: ${maxQuantity.toFixed(3)}`);

            // Get unit name from selected product size
            let unitName = '';
            if (selectedProductSize && selectedProductSize.measuringUnitName) {
                unitName = selectedProductSize.measuringUnitName;
            } else if (selectedProductSize && selectedProductSize.measuringUnitAbbreviation) {
                unitName = selectedProductSize.measuringUnitAbbreviation;
            }

            // Add visual indicator with unit name - show full decimal value
            // Try multiple selectors to find the label
            let quantityLabel = document.querySelector('label[for="quantity"]');
            if (!quantityLabel) {
                // Try jQuery selector as fallback
                const $label = $('label[for="quantity"]');
                if ($label.length > 0) {
                    quantityLabel = $label[0];
                }
            }

            if (quantityLabel) {
                if (unitName) {
                    quantityLabel.innerHTML = `Quantity (${unitName}): <small class="text-muted">(Available: ${maxQuantity.toFixed(3)} ${unitName})</small>`;
                } else {
                    quantityLabel.innerHTML = `Quantity: <small class="text-muted">(Available: ${maxQuantity.toFixed(3)})</small>`;
                }
                console.log('Label updated successfully:', quantityLabel.innerHTML);
            } else {
                console.error('Quantity label not found - trying to find it...');
                // Try to find by text content
                const labels = document.querySelectorAll('label');
                for (let label of labels) {
                    if (label.getAttribute('for') === 'quantity' || label.textContent.trim().toLowerCase().includes('quantity')) {
                        console.log('Found label by searching:', label);
                        if (unitName) {
                            label.innerHTML = `Quantity (${unitName}): <small class="text-muted">(Available: ${maxQuantity.toFixed(3)} ${unitName})</small>`;
                        } else {
                            label.innerHTML = `Quantity: <small class="text-muted">(Available: ${maxQuantity.toFixed(3)})</small>`;
                        }
                        break;
                    }
                }
            }
        }

        // Keep loadProductSizeData for backward compatibility if needed
        function loadProductSizeData(productRangeId) {
            onProductSizeChange();
        }

        function loadProductStock(productId) {
            // Use VendorBills available stock endpoint
            $.get("/VendorBills/GetAvailableStock", { productId: productId })
                .done(function(data) {
                    if (data.success) {
                        // You can display stock information if needed
                        console.log("Available stock:", data.availableQuantity);
                    }
                })
                .fail(function() {
                    console.error("Error loading product stock");
                });
        }

        function loadNextBillNumber(vendorId = null) {
            var url = "/VendorBills/GetNextBillNumber";
            if (vendorId) {
                url += "?vendorId=" + vendorId;
            }

            console.log("Loading next bill number for vendor:", vendorId, "URL:", url);

            $.get(url)
                .done(function(data) {
                    console.log("Next bill number response:", data);
                    if (data.success) {
                        console.log("Setting bill number to:", data.billNumber);
                        $("#billNumber").val(data.billNumber);
                        console.log("Bill number field value after setting:", $("#billNumber").val());
                    } else {
                        console.error("Failed to get next bill number:", data.message);
                    }
                })
                .fail(function(xhr, status, error) {
                    console.error("Error loading next bill number:", error);
                });
        }

        function calculatePayableAmount() {
            var quantity = parseFloat($("#quantity").val()) || 0;
            var unitPrice = parseFloat($("#unitPrice").val()) || 0;
            var purchasePrice = parseFloat($("#purchasePrice").val()) || 0;
            var discountAmount = parseFloat($("#discountAmount").val()) || 0;

            var totalAmount = quantity * purchasePrice; // Use purchase price instead of unit price
            var totalDiscount = discountAmount * quantity; // Calculate total discount
            var payableAmount = totalAmount - totalDiscount; // Use total discount instead of per-unit discount

            $("#payableAmount").val(payableAmount.toFixed(2));
        }

        function calculateDueAmount() {
            var totalAmount = parseFloat($("#totalAmount").val()) || 0;
            var discountAmountTotal = parseFloat($("#discountAmountTotal").val()) || 0;
            var payNow = parseFloat($("#payNow").val()) || 0;

            // Calculate due amount for current bill only (not including previous dues)
            var netTotal = totalAmount - discountAmountTotal;
            var dueAmount = netTotal - payNow;

            $("#dueAmount").val(dueAmount.toFixed(2));
            $("#receivedAmount").val(payNow);
        }

        function calculateTotals() {
            var totalAmount = 0;
            var totalDiscount = 0;

            billDetails.forEach(function(item) {
                totalAmount += item.payableAmount;
                totalDiscount += item.lineDiscountAmount;
            });

            $("#totalAmount").val(totalAmount.toFixed(2));
            $("#discountAmountTotal").val(totalDiscount.toFixed(2));

            // Update bill amount if online payment is selected
            var paymentMethod = $("#paymentMethod").val();
            if (paymentMethod === "Online") {
                updateBillAmount();
            }

            calculateDueAmount();
        }

        function addProductToTable() {
            debugger;
            var productComboBox = $("#productSelect").data("kendoComboBox");
            var productSizeComboBox = $("#productSizeSelect").data("kendoComboBox");

            if (!productComboBox.value()) {
                showWarningMessage("Please select a product");
                return;
            }

            if (!productSizeComboBox.value()) {
                showWarningMessage("Please select a product size");
                return;
            }

            var selectedProduct = productComboBox.dataItem();

            if (!selectedProductSize) {
                showWarningMessage("Please select a product size");
                return;
            }

            var quantity = parseFloat($("#quantity").val()) || 0;
            var unitPrice = parseFloat($("#unitPrice").val()) || 0;
            var purchasePrice = parseFloat($("#purchasePrice").val()) || 0;
            var discountAmount = parseFloat($("#discountAmount").val()) || 0;
            var payableAmount = parseFloat($("#payableAmount").val()) || 0;

            if (quantity <= 0) {
                showWarningMessage("Please enter a valid quantity");
                return;
            }

            // Check stock availability
            // if (quantity > currentAvailableStock) {
            //     showWarningMessage(`Insufficient stock! Available quantity: ${currentAvailableStock.toFixed(3)}. You cannot add more than the available stock.`);
            //     return;
            // }

            // Get measuring unit abbreviation from selected product size - match Sales pattern exactly
            var measuringUnitAbbreviation = selectedProductSize ? (selectedProductSize.measuringUnitAbbreviation || 'N/A') : 'N/A';

            console.log('Adding product to table:', {
                productId: selectedProduct.value,
                productName: selectedProduct.text,
                measuringUnitAbbreviation: measuringUnitAbbreviation,
                selectedProductSize: selectedProductSize,
                productRangeId: selectedProductSize.productRangeId,
                quantity: quantity
            });

            // Convert quantity to base unit if needed (for storage in database)
            // Get product's base unit first
            fetch(`/VendorBills/GetAvailableStock?productId=${selectedProduct.value}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.baseUnitId) {
                        const productBaseUnitId = data.baseUnitId;
                        const productSizeUnitId = selectedProductSize.measuringUnitId;

                        // If product size unit is same as base unit, no conversion needed
                        if (productSizeUnitId == productBaseUnitId) {
                            addBillDetailToArray(quantity, quantity);
                        } else {
                            // Convert quantity from product size unit to base unit
                            console.log('Converting quantity to base unit:', {
                                quantity: quantity,
                                fromUnitId: productSizeUnitId,
                                toUnitId: productBaseUnitId
                            });

                            fetch(`/VendorBills/ConvertQuantityToBaseUnit?productId=${selectedProduct.value}&fromUnitId=${productSizeUnitId}&toUnitId=${productBaseUnitId}&quantity=${quantity}`)
                                .then(response => response.json())
                                .then(conversionData => {
                                    if (conversionData.success) {
                                        const baseUnitQuantity = conversionData.convertedQuantity;
                                        console.log('Quantity converted to base unit:', {
                                            originalQuantity: quantity,
                                            baseUnitQuantity: baseUnitQuantity,
                                            conversionFactor: conversionData.conversionFactor
                                        });
                                        addBillDetailToArray(quantity, baseUnitQuantity);
                                    } else {
                                        console.warn('Conversion failed, using original quantity');
                                        addBillDetailToArray(quantity, quantity);
                                    }
                                })
                                .catch(error => {
                                    console.error('Error converting quantity:', error);
                                    addBillDetailToArray(quantity, quantity);
                                });
                        }
                    } else {
                        // No base unit found, use quantity as is
                        addBillDetailToArray(quantity, quantity);
                    }
                })
                .catch(error => {
                    console.error('Error getting base unit:', error);
                    addBillDetailToArray(quantity, quantity);
                });
        }

        // Function to add bill detail to array with both display and base unit quantities
        function addBillDetailToArray(displayQuantity, baseUnitQuantity) {
            var productComboBox = $("#productSelect").data("kendoComboBox");
            var selectedProduct = productComboBox.dataItem();
            var unitPrice = parseFloat($("#unitPrice").val()) || 0;
            var purchasePrice = parseFloat($("#purchasePrice").val()) || 0;
            var discountAmount = parseFloat($("#discountAmount").val()) || 0;
            var payableAmount = parseFloat($("#payableAmount").val()) || 0;
            var measuringUnitAbbreviation = selectedProductSize ? (selectedProductSize.measuringUnitAbbreviation || 'N/A') : 'N/A';

            var billDetail = {
                productId: parseInt(selectedProduct.value),
                productName: selectedProduct.text,
                productCode: selectedProduct.code || "",
                measuringUnitAbbreviation: measuringUnitAbbreviation,
                measuringUnitId: selectedProductSize.measuringUnitId,
                unitPrice: unitPrice,
                purchasePrice: purchasePrice,
                quantity: displayQuantity, // Display quantity in product size unit
                baseUnitQuantity: baseUnitQuantity, // Base unit quantity for database
                salePrice: unitPrice,
                lineDiscountAmount: discountAmount * displayQuantity,
                payableAmount: payableAmount,
                productRangeId: selectedProductSize.productRangeId
            };

            if (editingIndex >= 0) {
                // Add the updated item back to the array
                billDetails.push(billDetail);
                editingIndex = -1;
                $("#addToTable").text("Add to Bill");
            } else {
                billDetails.push(billDetail);
            }

            // Update available stock after adding item (for vendor bills, adding increases stock)
            updateAvailableStockAfterAdd(baseUnitQuantity);

            updateBillDetailsTable();
            calculateTotals();
            resetProductFields();
        }

        // Function to update available stock after adding an item
        function updateAvailableStockAfterAdd(quantityInBaseUnit) {
            // For vendor bills, we're adding stock (increasing), so we add the quantity back
            // Get the current product size selection to determine the unit
            const productCombo = $("#productSelect").data("kendoComboBox");
            const currentProductId = productCombo ? productCombo.value() : null;

            // Only update stock if the added item is from the currently selected product
            if (currentProductId && selectedProductSize) {
                const productSizeUnitId = selectedProductSize.measuringUnitId;

                // Get base unit and convert quantityInBaseUnit to product size unit for display
                fetch(`/VendorBills/GetAvailableStock?productId=${currentProductId}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success && data.baseUnitId) {
                            const productBaseUnitId = data.baseUnitId;

                            if (productSizeUnitId == productBaseUnitId) {
                                // Same unit, just add back (vendor bills increase stock)
                                currentAvailableStock = currentAvailableStock + quantityInBaseUnit;
                                updateStockDisplay();
                            } else {
                                // Convert quantityInBaseUnit to product size unit for display
                                fetch(`/VendorBills/ConvertUnitAndGetStock?productId=${currentProductId}&fromUnitId=${productBaseUnitId}&toUnitId=${productSizeUnitId}&stockInBaseUnit=${quantityInBaseUnit}`)
                                    .then(response => response.json())
                                    .then(conversionData => {
                                        if (conversionData.success) {
                                            const quantityInProductSizeUnit = conversionData.convertedStock;
                                            currentAvailableStock = currentAvailableStock + quantityInProductSizeUnit;
                                            updateStockDisplay();
                                        } else {
                                            // Fallback: just add back base unit (may show incorrect value)
                                            currentAvailableStock = currentAvailableStock + quantityInBaseUnit;
                                            updateStockDisplay();
                                        }
                                    })
                                    .catch(error => {
                                        console.error('Error converting quantity for stock update:', error);
                                        currentAvailableStock = currentAvailableStock + quantityInBaseUnit;
                                        updateStockDisplay();
                                    });
                            }
                        } else {
                            // No base unit, just add back
                            currentAvailableStock = currentAvailableStock + quantityInBaseUnit;
                            updateStockDisplay();
                        }
                    })
                    .catch(error => {
                        console.error('Error updating stock after add:', error);
                    });
            }
        }

        function updateBillDetailsTable() {
            var tbody = $("#billDetailsBody");
            tbody.empty();

            console.log('updateBillDetailsTable called. billDetails length:', billDetails ? billDetails.length : 'billDetails is undefined');

            if (!billDetails || billDetails.length === 0) {
                console.warn('No bill details to display. billDetails is empty or undefined.');
                return;
            }

            billDetails.forEach(function(item, index) {
                console.log('Processing item at index', index, ':', item);
                console.log('Item measuringUnitAbbreviation:', item.measuringUnitAbbreviation);
                console.log('Item productCode:', item.productCode);

                var row = $("<tr>");
                // Helper function to safely format decimal values
                function safeToFixed(value, decimals) {
                    if (value === null || value === undefined || isNaN(value)) {
                        return "0.00";
                    }
                    return parseFloat(value).toFixed(decimals || 2);
                }

                // Calculate unit discount price safely
                var unitDiscountPrice = 0;
                if (item.quantity && item.quantity > 0 && item.lineDiscountAmount) {
                    unitDiscountPrice = item.lineDiscountAmount / item.quantity;
                }

                // Ensure we use measuringUnitAbbreviation, not productCode
                var measuringUnit = item.measuringUnitAbbreviation ||
                                   item.MeasuringUnitAbbreviation ||
                                   item.measuring_unit_abbreviation ||
                                   "N/A";

                // Double check we're not accidentally using productCode
                if (measuringUnit === "N/A" && item.productCode) {
                    console.warn("Warning: measuringUnitAbbreviation is N/A, but productCode exists:", item.productCode);
                    console.warn("This should not happen - measuring unit should come from product size selection");
                }

                row.append("<td>" + measuringUnit + "</td>");
                row.append("<td>" + (item.productName || "") + "</td>");
                row.append("<td>" + safeToFixed(unitDiscountPrice, 2) + "</td>");
                row.append("<td>" + safeToFixed(item.unitPrice, 2) + "</td>");
                row.append("<td>" + safeToFixed(item.purchasePrice, 2) + "</td>");
                // Display quantity with unit abbreviation and decimal precision
                var displayQuantity = (item.quantity || 0).toFixed(3);
                var quantityDisplay = measuringUnit !== "N/A" ? displayQuantity + " " + measuringUnit : displayQuantity;
                row.append("<td>" + quantityDisplay + "</td>");
                row.append("<td>" + safeToFixed(item.lineDiscountAmount, 2) + "</td>");
                row.append("<td>" + safeToFixed(item.payableAmount, 2) + "</td>");
                row.append("<td>"
                    + "<button type='button' class='btn btn-sm btn-warning me-1 edit-row' data-index='" + index + "' title='Edit'><i class='fa-solid fa-edit'></i></button>"
                    + "<button type='button' class='btn btn-sm btn-danger remove-row' data-index='" + index + "' title='Remove'><i class='fa-solid fa-trash'></i></button>"
                    + "</td>");
                tbody.append(row);
            });
        }

        function removeBillDetail(index) {
            billDetails.splice(index, 1);
            updateBillDetailsTable();
            calculateTotals();
        }

        function resetProductFields() {
            $("#productSelect").data("kendoComboBox").value("");
            // $("#customerSelect").data("kendoComboBox").value("");
            // $("#vendorSelect").data("kendoComboBox").value("");
            $("#productSizeSelect").data("kendoComboBox").value("");
            $("#quantity").val("1");
            $("#unitPrice").val("0");
            $("#purchasePrice").val("0");
            $("#discountAmount").val("0");
            $("#payableAmount").val("0");

            currentProductId = null;
            currentProductRangeId = null;
            selectedProductSize = null;
            currentAvailableStock = 0;

            // Reset quantity label
            const quantityLabel = document.querySelector('label[for="quantity"]');
            if (quantityLabel) {
                quantityLabel.innerHTML = "Quantity:";
            }
        }

        // Function to update available stock after removing an item
        function updateAvailableStockAfterRemove(quantityInBaseUnit) {
            // For vendor bills, we're removing stock (decreasing), so we subtract the quantity
            // Get the current product size selection to determine the unit
            const productCombo = $("#productSelect").data("kendoComboBox");
            const currentProductId = productCombo ? productCombo.value() : null;

            // Only update stock if the removed item is from the currently selected product
            if (currentProductId && selectedProductSize) {
                const productSizeUnitId = selectedProductSize.measuringUnitId;

                // Get base unit and convert quantityInBaseUnit to product size unit for display
                fetch(`/VendorBills/GetAvailableStock?productId=${currentProductId}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success && data.baseUnitId) {
                            const productBaseUnitId = data.baseUnitId;

                            if (productSizeUnitId == productBaseUnitId) {
                                // Same unit, just subtract
                                currentAvailableStock = Math.max(0, currentAvailableStock - quantityInBaseUnit);
                                updateStockDisplay();
                            } else {
                                // Convert quantityInBaseUnit to product size unit for display
                                fetch(`/VendorBills/ConvertUnitAndGetStock?productId=${currentProductId}&fromUnitId=${productBaseUnitId}&toUnitId=${productSizeUnitId}&stockInBaseUnit=${quantityInBaseUnit}`)
                                    .then(response => response.json())
                                    .then(conversionData => {
                                        if (conversionData.success) {
                                            const quantityInProductSizeUnit = conversionData.convertedStock;
                                            currentAvailableStock = Math.max(0, currentAvailableStock - quantityInProductSizeUnit);
                                            updateStockDisplay();
                                        } else {
                                            // Fallback: just subtract base unit (may show incorrect value)
                                            currentAvailableStock = Math.max(0, currentAvailableStock - quantityInBaseUnit);
                                            updateStockDisplay();
                                        }
                                    })
                                    .catch(error => {
                                        console.error('Error converting quantity for stock update:', error);
                                        currentAvailableStock = Math.max(0, currentAvailableStock - quantityInBaseUnit);
                                        updateStockDisplay();
                                    });
                            }
                        } else {
                            // No base unit, just subtract
                            currentAvailableStock = Math.max(0, currentAvailableStock - quantityInBaseUnit);
                            updateStockDisplay();
                        }
                    })
                    .catch(error => {
                        console.error('Error updating stock after remove:', error);
                    });
            }
        }

        // Form submission
        $("#generateBillForm").on("submit", function(e) {
            e.preventDefault();

            var actionType = $("#actionType").val();

            if (actionType === "saveAndPrint") {
                saveAndPrintBill();
            } else {
                saveBill();
            }
        });

        // Save Bill function
        function saveBill() {
            debugger;
            if (!validateBillForm()) {
                return;
            }

            console.log('=== AJAX Save Bill called ===');
            showLoadingState();

            try {
                // Collect form data
                const formData = collectBillFormData('save');
                console.log('Form data collected:', formData);

                // Determine the correct URL based on edit mode
                var billId = $("#billId").val();
                var isEdit = (typeof isEditMode !== 'undefined' && (isEditMode === 'true' || isEditMode === true)) && billId;
                var url = isEdit ? '/VendorBills/Edit/' + billId : '/VendorBills/GenerateBill';
                console.log('Submitting to URL:', url, 'isEdit:', isEdit, 'billId:', billId);

                // Make AJAX call
                $.ajax({
                    url: url,
                    type: 'POST',
                    data: formData,
                    dataType: 'json',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    success: function(response) {
                        console.log('AJAX Save Bill success:', response);
                        hideLoadingState();

                        if (response.success) {
                            var message = isEdit ? 'Bill updated successfully!' : 'Bill saved successfully!';
                            showSuccessMessage(message);

                            if (isEdit) {
                                // For edit mode, redirect to index after a short delay
                                setTimeout(function() {
                                    window.location.href = '/VendorBills';
                                }, 1500);
                            } else {
                                // Reset form after successful save (only for new bills)
                                resetBillForm();
                            }
                        } else {
                            showErrorMessage(response.message || (isEdit ? 'Failed to update bill' : 'Failed to save bill'));
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('AJAX Save Bill error:', error);
                        console.error('Response status:', xhr.status);
                        console.error('Response text:', xhr.responseText);
                        hideLoadingState();

                        var errorMessage = 'Error saving bill: ' + error;
                        if (xhr.responseJSON && xhr.responseJSON.message) {
                            errorMessage = xhr.responseJSON.message;
                        }
                        showErrorMessage(errorMessage);
                    }
                });
            } catch (error) {
                console.error('Error in saveBill function:', error);
                hideLoadingState();
                showErrorMessage('Error preparing bill data: ' + error.message);
            }
        }

        // Save and Print Bill function
        function saveAndPrintBill() {
            debugger;
            if (!validateBillForm()) {
                return;
            }

            console.log('=== AJAX Save and Print Bill called ===');
            showLoadingState();

            try {
                // Collect form data
                const formData = collectBillFormData('saveAndPrint');
                console.log('Form data collected:', formData);

                // Determine the correct URL based on edit mode
                var billId = $("#billId").val();
                var isEdit = (typeof isEditMode !== 'undefined' && (isEditMode === 'true' || isEditMode === true)) && billId;
                var url = isEdit ? '/VendorBills/Edit/' + billId : '/VendorBills/GenerateBill';
                console.log('Submitting to URL:', url, 'isEdit:', isEdit, 'billId:', billId);

                // Make AJAX call
                $.ajax({
                    url: url,
                    type: 'POST',
                    data: formData,
                    dataType: 'json',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    success: function(response) {
                        console.log('AJAX Save and Print Bill success:', response);
                        hideLoadingState();

                        if (response.success) {
                            var message = isEdit ? 'Bill updated successfully!' : 'Bill saved successfully!';
                            showSuccessMessage(message);

                            // Get billId from response or use existing billId for edit mode
                            var billIdForPrint = response.billId || billId;

                            if (!isEdit) {
                                // Reset form after successful save (only for new bills)
                                resetBillForm();
                            }

                            // Open print windows for both vendor and merchant copies in separate tabs
                            if (billIdForPrint) {
                                // Open vendor copy in new tab and print
                                const vendorPrintUrl = '/VendorBills/PrintReceipt/' + billIdForPrint + '?print=true&merchantCopy=false';
                                const vendorWindow = window.open(vendorPrintUrl, '_blank');

                                // Open merchant copy in another new tab after a delay
                                setTimeout(function() {
                                    const merchantPrintUrl = '/VendorBills/PrintReceipt/' + billIdForPrint + '?print=true&merchantCopy=true';
                                    const merchantWindow = window.open(merchantPrintUrl, '_blank');

                                    // Show notification about both copies being opened
                                    showSuccessMessage('Both Vendor Copy and Merchant Copy have been opened in separate tabs!');
                                }, 1000); // 1 second delay between tabs
                            }
                        } else {
                            showErrorMessage(response.message || (isEdit ? 'Failed to update bill' : 'Failed to save bill'));
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('AJAX Save and Print Bill error:', error);
                        console.error('Response status:', xhr.status);
                        console.error('Response text:', xhr.responseText);
                        hideLoadingState();

                        var errorMessage = 'Error saving bill: ' + error;
                        if (xhr.responseJSON && xhr.responseJSON.message) {
                            errorMessage = xhr.responseJSON.message;
                        }
                        showErrorMessage(errorMessage);
                    }
                });
            } catch (error) {
                console.error('Error in saveAndPrintBill function:', error);
                hideLoadingState();
                showErrorMessage('Error preparing bill data: ' + error.message);
            }
        }

        // Function to load online accounts
        function loadOnlineAccounts() {
            debugger;
            const onlineAccountCombo = $("#onlineAccountSelect").data("kendoComboBox");
            if (onlineAccountCombo) {
                console.log("Loading online accounts from server...");
                fetch("/VendorBills/GetOnlineAccounts")
                    .then(response => {
                        console.log("Online accounts response status:", response.status);
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log("Online accounts data received:", data);
                        if (data && data.data && data.data.length > 0) {
                            onlineAccountCombo.dataSource.data(data.data);
                            onlineAccountCombo.enable(true);
                            onlineAccountCombo.refresh();
                            console.log("Online accounts loaded successfully");
                        } else {
                            console.log("No online accounts found");
                            onlineAccountCombo.dataSource.data([]);
                            onlineAccountCombo.enable(false);
                        }
                    })
                    .catch(error => {
                        console.error("Error loading online accounts:", error);
                        onlineAccountCombo.dataSource.data([]);
                        onlineAccountCombo.enable(false);
                    });
            }
        }

        // Function to load account balance
        function loadAccountBalance(accountId) {
            console.log("Loading account balance for account:", accountId);
            fetch(`/VendorBills/GetAccountBalance?accountId=${accountId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log("Account balance data received:", data);
                    if (data.success) {
                        $("#accountBalance").val(data.balance.toFixed(2));
                        updateBillAmount();
                    } else {
                        console.error("Error loading account balance:", data.message);
                        $("#accountBalance").val("");
                    }
                })
                .catch(error => {
                    console.error("Error loading account balance:", error);
                    $("#accountBalance").val("");
                });
        }

        // Function to update bill amount
        function updateBillAmount() {
            var totalAmount = parseFloat($("#totalAmount").val()) || 0;
            var discountAmountTotal = parseFloat($("#discountAmountTotal").val()) || 0;
            var payNow = parseFloat($("#payNow").val()) || 0;

            var billAmount = totalAmount - discountAmountTotal;
            $("#billAmount").val(billAmount.toFixed(2));
        }

        // Function to validate account balance
        function validateAccountBalance() {
            var paymentMethod = $("#paymentMethod").val();

            if (paymentMethod === "Online") {
                var accountBalance = parseFloat($("#accountBalance").val()) || 0;
                var payNow = parseFloat($("#payNow").val()) || 0;

                // Clear previous validation styling
                $("#payNow").removeClass('is-invalid');
                $("#accountBalance").removeClass('is-invalid');

                // if (accountBalance <= 0) {
                //     $("#accountBalance").addClass('is-invalid');
                //     showWarningMessage("Account balance is insufficient. Available balance: $" + accountBalance.toFixed(2));
                //     return false;
                // }

                // if (payNow > accountBalance) {
                //     $("#payNow").addClass('is-invalid');
                //     showWarningMessage("Payment amount exceeds available account balance. Available balance: $" + accountBalance.toFixed(2) + ", Payment amount: $" + payNow.toFixed(2));
                //     return false;
                // }

                // Clear validation styling if balance is sufficient
                $("#payNow").removeClass('is-invalid');
                $("#accountBalance").removeClass('is-invalid');
            }

            return true;
        }

        // Function to show warning message (toaster-style)
        function showWarningMessage(message) {
            // Remove existing warning messages
            $('.alert-warning').remove();

            // Create warning alert
            var alertHtml = '<div class="alert alert-warning alert-dismissible fade show" role="alert" style="position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px;">' +
                '<i class="fa-solid fa-exclamation-triangle me-2"></i>' +
                message +
                '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>' +
                '</div>';

            $('body').append(alertHtml);

            // Auto-hide after 5 seconds
            setTimeout(function() {
                $('.alert-warning').fadeOut();
            }, 5000);
        }

        // Function to validate bill form
        function validateBillForm() {
            debugger;
            // Validate vendor selection
            var vendorCombo = $("#vendorSelect").data("kendoComboBox");
            var vendorId = vendorCombo ? vendorCombo.value() : null;

            var customerCombo = $("#customerSelect").data("kendoComboBox");
            var CustomerId = customerCombo ? customerCombo.value() : null;

            if ((!vendorId || vendorId === '') &&  (!CustomerId || CustomerId==='') ) {
                showWarningMessage("Please select a vendor or Customer from the dropdown.");
                $("#vendorSelect").addClass('is-invalid');
                return false;
            }

            // Clear vendor validation styling if vendor is selected
            $("#vendorSelect").removeClass('is-invalid');

            if (billDetails.length === 0) {
                showWarningMessage("Please add at least one product to the bill");
                return false;
            }

            // Validate Pay Now based on Payment Method
            var paymentMethod = $("#paymentMethod").val();
            var payNow = parseFloat($("#payNow").val()) || 0;

            if (paymentMethod !== "PayLater" && payNow <= 0) {
                showWarningMessage("Pay Now amount is required when payment method is not 'Pay Later'.");
                return false;
            }

            // Validate Online Account selection for Online payment method
            if (paymentMethod === "Online") {
                var onlineAccountCombo = $("#onlineAccountSelect").data("kendoComboBox");
                var onlineAccountId = onlineAccountCombo ? onlineAccountCombo.value() : null;

                if (!onlineAccountId || onlineAccountId === '') {
                    showWarningMessage("Please select an online account for online payment.");
                    return false;
                }

                // Validate account balance
                var accountBalance = parseFloat($("#accountBalance").val()) || 0;
                var payNow = parseFloat($("#payNow").val()) || 0;

                // if (accountBalance <= 0) {
                //     showWarningMessage("Account balance is insufficient. Available balance: $" + accountBalance.toFixed(2));
                //     return false;
                // }

                // if (payNow > accountBalance) {
                //     showWarningMessage("Payment amount exceeds available account balance. Available balance: $" + accountBalance.toFixed(2) + ", Payment amount: $" + payNow.toFixed(2));
                //     return false;
                // }
            }

            return true;
        }

        // Function to collect form data for AJAX submission
        function collectBillFormData(actionType) {
            debugger;
            // Get anti-forgery token
            var token = $('input[name="__RequestVerificationToken"]').val();

            var formData = {
                __RequestVerificationToken: token,
                VendorId: parseInt($("#vendorSelect").val()) || 0,
                CustomerId: parseInt($("#customerSelect").val()) || 0,
                BillNumber: parseInt($("#billNumber").val()) || 0,
                BillDate: $("#billDate").val(),
                TotalAmount: parseFloat($("#totalAmount").val()) || 0,
                DiscountAmount: parseFloat($("#discountAmountTotal").val()) || 0,
                PaidAmount: parseFloat($("#payNow").val()) || 0,
                DueAmount: parseFloat($("#dueAmount").val()) || 0,
                PreviousDue: parseFloat($("#previousDue").val()) || 0,
                PayNow: parseFloat($("#payNow").val()) || 0,
                Description: $("#description").val() || "",
                PaymentMethod: $("#paymentMethod").val(),
                OnlineAccountId: $("#onlineAccountSelect").val() ? parseInt($("#onlineAccountSelect").val()) : null,
                ActionType: actionType,
                BillDetails: []
            };

            // Add bill details - use baseUnitQuantity if available, otherwise use quantity
            billDetails.forEach(function(item) {
                formData.BillDetails.push({
                    ProductId: parseInt(item.productId),
                    ProductRangeId: parseInt(item.productRangeId),
                    ProductSize: item.measuringUnitAbbreviation || "",
                    UnitPrice: parseFloat(item.unitPrice),
                    PurchasePrice: parseFloat(item.purchasePrice),
                    Quantity: parseFloat(item.baseUnitQuantity || item.quantity), // Use base unit quantity for database
                    SalePrice: parseFloat(item.salePrice),
                    LineDiscountAmount: parseFloat(item.lineDiscountAmount),
                    PayableAmount: parseFloat(item.payableAmount)
                });
            });

            // Debug logging
            console.log('Form data being sent:', JSON.stringify(formData, null, 2));
            console.log('Bill details count:', formData.BillDetails.length);
            console.log('VendorId:', formData.VendorId);
            console.log('BillNumber:', formData.BillNumber);
            console.log('PaymentMethod:', formData.PaymentMethod);

            return formData;
        }

        // Function to reset bill form
        function resetBillForm() {
            // Clear bill details
            billDetails = [];
            updateBillDetailsTable();

            // Reset form fields
            $("#vendorSelect").data("kendoComboBox").value("");
            $("#customerSelect").data("kendoComboBox").value("");
            $("#billDate").val(new Date().toISOString().split('T')[0]);
            $("#totalAmount").val("0");
            $("#discountAmountTotal").val("0");
            $("#payNow").val("0");
            $("#dueAmount").val("0");
            $("#previousDue").val("0");
            $("#description").val("");
            $("#receivedAmount").val("");
            $("#paymentMethod").val("Cash");
            $("#onlineAccountSelect").data("kendoComboBox").value("");

            // Hide online account sections
            $("#onlineAccountSection").hide();
            $("#accountBalanceSection").hide();
            $("#billAmountSection").hide();

            // Reset product fields
            resetProductFields();

            // Reset action type
            $("#actionType").val("save");

            // Reload next bill number (without vendor ID since vendor is cleared)
            console.log("Resetting form and loading next bill number...");
            loadNextBillNumber();
        }

        // Function to show loading state
        function showLoadingState() {
            $("#saveButton").prop("disabled", true).html('<i class="fa-solid fa-spinner fa-spin me-1"></i>Saving...');
            $("#saveAndPrintButton").prop("disabled", true).html('<i class="fa-solid fa-spinner fa-spin me-1"></i>Saving...');
        }

        // Function to hide loading state
        function hideLoadingState() {
            $("#saveButton").prop("disabled", false).html('<i class="fa-solid fa-save me-1"></i>Save');
            $("#saveAndPrintButton").prop("disabled", false).html('<i class="fa-solid fa-print me-1"></i>Save & Print');
        }

        // Function to show success message
        function showSuccessMessage(message) {
            // Remove existing success messages
            $('.alert-success').remove();

            // Create success alert
            var alertHtml = '<div class="alert alert-success alert-dismissible fade show" role="alert" style="position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px;">' +
                '<i class="fa-solid fa-check-circle me-2"></i>' +
                message +
                '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>' +
                '</div>';

            $('body').append(alertHtml);

            // Auto-hide after 3 seconds
            setTimeout(function() {
                $('.alert-success').fadeOut();
            }, 3000);
        }

        // Function to show error message
        function showErrorMessage(message) {
            // Remove existing error messages
            $('.alert-danger').remove();

            // Create error alert
            var alertHtml = '<div class="alert alert-danger alert-dismissible fade show" role="alert" style="position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px;">' +
                '<i class="fa-solid fa-exclamation-circle me-2"></i>' +
                message +
                '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>' +
                '</div>';

            $('body').append(alertHtml);

            // Auto-hide after 5 seconds
            setTimeout(function() {
                $('.alert-danger').fadeOut();
            }, 5000);
        }

        // Function to populate form fields in edit mode
        function populateEditForm() {
            // Prevent multiple simultaneous calls
            if (isPopulatingEditForm) {
                console.warn('populateEditForm is already running, skipping duplicate call');
                return;
            }

            isPopulatingEditForm = true;
            console.log('Populating edit form with existing data...');
            console.log('isEditMode:', isEditMode);
            console.log('billDetailsData:', billDetailsData);
            console.log('billDetailsData type:', typeof billDetailsData);
            console.log('billDetailsData length:', billDetailsData ? billDetailsData.length : 'undefined');

            // Clear existing billDetails to prevent duplicates
            billDetails = [];
            console.log('Cleared billDetails array. Current length:', billDetails.length);

            // Populate Payment Method from model
            var paymentMethodValue = $("#paymentMethod").attr('data-value') || $("#paymentMethod").val();
            if (paymentMethodValue) {
                setTimeout(function() {
                    var paymentMethodDD = $("#paymentMethod").data("kendoDropDownList");
                    if (paymentMethodDD) {
                        paymentMethodDD.value(paymentMethodValue);
                        // Trigger change event to show/hide online account section
                        if (paymentMethodValue === "Online") {
                            $("#onlineAccountSection").show();
                            $("#accountBalanceSection").show();
                            $("#billAmountSection").show();
                        }
                    }
                }, 200);
            }

            // Populate Online Account if Payment Method is Online
            var onlineAccountId = $("#onlineAccountSelect").attr('data-value') || $("#onlineAccountSelect").val();
            if (onlineAccountId && paymentMethodValue === "Online") {
                setTimeout(function() {
                    var onlineAccountCombo = $("#onlineAccountSelect").data("kendoComboBox");
                    if (onlineAccountCombo) {
                        onlineAccountCombo.value(onlineAccountId);
                        onlineAccountCombo.enable(true);
                    }
                }, 400);
            }

            // Populate basic form fields
            if ($("#vendorSelect").val()) {
                var vendorCombo = $("#vendorSelect").data("kendoComboBox");
                if (vendorCombo) {
                    vendorCombo.value($("#vendorSelect").val());
                    // Load vendor data after setting value
                    setTimeout(function() {
                        // loadVendorData($("#vendorSelect").val());
                        loadVendorPreviousDueAmount();
                    }, 500);
                }
            }

            // Populate bill details from server-side data
            console.log('Checking billDetailsData:', {
                defined: typeof billDetailsData !== 'undefined',
                isArray: Array.isArray(billDetailsData),
                length: billDetailsData ? billDetailsData.length : 'N/A',
                data: billDetailsData
            });

            if (typeof billDetailsData !== 'undefined' && billDetailsData && Array.isArray(billDetailsData) && billDetailsData.length > 0) {
                console.log('Loading bill details. Count:', billDetailsData.length);
                console.log('First item structure:', billDetailsData[0]);
                console.log('All billDetailsData:', billDetailsData);

                // Remove duplicates from billDetailsData before processing
                var uniqueBillDetailsData = [];
                var seenDataKeys = new Set();

                billDetailsData.forEach(function(item) {
                    var dataKey = (item.ProductId || item.productId || 0) + '_' + (item.ProductRangeId || item.productRangeId || 0);
                    if (!seenDataKeys.has(dataKey)) {
                        seenDataKeys.add(dataKey);
                        uniqueBillDetailsData.push(item);
                    } else {
                        console.warn('Duplicate item in billDetailsData found and removed:', item);
                    }
                });

                console.log('Unique billDetailsData count:', uniqueBillDetailsData.length);
                console.log('Original billDetailsData count:', billDetailsData.length);

                // Use unique data for processing
                billDetailsData = uniqueBillDetailsData;

                // Process items with unit conversion
                var processPromises = [];

                billDetailsData.forEach(function(item, idx) {
                    console.log('Processing item', idx, ':', item);

                    var productId = item.ProductId || item.productId || 0;
                    var productRangeId = item.ProductRangeId || item.productRangeId || 0;
                    var baseUnitQuantity = parseFloat(item.Quantity || item.quantity || 0); // This is stored in base unit
                    var measuringUnitId = item.MeasuringUnitId || item.measuringUnitId || null;
                    // Get measuring unit abbreviation from the item, don't use ProductSize (which is a range string)
                    var measuringUnitAbbreviation = item.MeasuringUnitAbbreviation || item.measuringUnitAbbreviation || '';

                    console.log('Item', idx, '- ProductId:', productId, 'ProductRangeId:', productRangeId, 'BaseQuantity:', baseUnitQuantity, 'MeasuringUnitId:', measuringUnitId, 'MeasuringUnitAbbreviation:', measuringUnitAbbreviation);

                    // Create a promise for each item to handle async conversion
                    var promise = new Promise(function(resolve) {
                        // First, try to get measuring unit abbreviation from product range if not provided
                        var getMeasuringUnitAbbreviation = function(abbreviation, pid, prId) {
                            if (abbreviation && abbreviation.trim() !== '') {
                                return Promise.resolve(abbreviation);
                            }
                            // If abbreviation is not provided, fetch it from product sizes
                            if (pid && prId) {
                                return fetch('/VendorBills/GetProductSizes?productId=' + pid)
                                    .then(function(response) { return response.json(); })
                                    .then(function(sizes) {
                                        if (Array.isArray(sizes) && sizes.length > 0) {
                                            var matchingSize = sizes.find(function(s) {
                                                return (s.productRangeId || s.ProductRangeId) == prId;
                                            });
                                            if (matchingSize && (matchingSize.measuringUnitAbbreviation || matchingSize.MeasuringUnitAbbreviation)) {
                                                return matchingSize.measuringUnitAbbreviation || matchingSize.MeasuringUnitAbbreviation;
                                            }
                                        }
                                        return 'N/A';
                                    })
                                    .catch(function(error) {
                                        console.error('Error fetching product sizes for abbreviation:', error);
                                        return 'N/A';
                                    });
                            }
                            return Promise.resolve('N/A');
                        };

                        // Get measuring unit abbreviation first
                        getMeasuringUnitAbbreviation(measuringUnitAbbreviation, productId, productRangeId)
                            .then(function(finalAbbreviation) {
                                measuringUnitAbbreviation = finalAbbreviation;
                                console.log('Item', idx, '- Final measuring unit abbreviation:', measuringUnitAbbreviation);

                                if (productId && measuringUnitId) {
                                    // Get product's base unit and convert quantity
                                    fetch('/VendorBills/GetAvailableStock?productId=' + productId)
                                        .then(function(response) { return response.json(); })
                                        .then(function(data) {
                                            if (data.success && data.baseUnitId) {
                                                var productBaseUnitId = parseInt(data.baseUnitId);
                                                var productSizeUnitId = parseInt(measuringUnitId);

                                                console.log('Item', idx, '- BaseUnitId:', productBaseUnitId, 'ProductSizeUnitId:', productSizeUnitId);

                                                if (productSizeUnitId && productSizeUnitId != productBaseUnitId) {
                                                    // Convert baseUnitQuantity to productSizeUnitId for display
                                                    fetch('/VendorBills/ConvertUnitAndGetStock?productId=' + productId + '&fromUnitId=' + productBaseUnitId + '&toUnitId=' + productSizeUnitId + '&stockInBaseUnit=' + baseUnitQuantity)
                                                        .then(function(response) { return response.json(); })
                                                        .then(function(conversionData) {
                                                            if (conversionData.success) {
                                                                var displayQuantity = conversionData.convertedStock;
                                                                console.log('Item', idx, '- Converted quantity:', displayQuantity, 'from base:', baseUnitQuantity);
                                                                resolve(createMappedItem(item, displayQuantity, baseUnitQuantity, measuringUnitAbbreviation, measuringUnitId));
                                                            } else {
                                                                console.warn('Item', idx, '- Conversion failed, using base quantity');
                                                                resolve(createMappedItem(item, baseUnitQuantity, baseUnitQuantity, measuringUnitAbbreviation, measuringUnitId));
                                                            }
                                                        })
                                                        .catch(function(error) {
                                                            console.error('Item', idx, '- Error converting quantity:', error);
                                                            resolve(createMappedItem(item, baseUnitQuantity, baseUnitQuantity, measuringUnitAbbreviation, measuringUnitId));
                                                        });
                                                } else {
                                                    // No conversion needed
                                                    console.log('Item', idx, '- No conversion needed, same unit');
                                                    resolve(createMappedItem(item, baseUnitQuantity, baseUnitQuantity, measuringUnitAbbreviation, measuringUnitId));
                                                }
                                            } else {
                                                console.warn('Item', idx, '- Could not get base unit, using base quantity');
                                                resolve(createMappedItem(item, baseUnitQuantity, baseUnitQuantity, measuringUnitAbbreviation, measuringUnitId));
                                            }
                                        })
                                        .catch(function(error) {
                                            console.error('Item', idx, '- Error fetching base unit:', error);
                                            resolve(createMappedItem(item, baseUnitQuantity, baseUnitQuantity, measuringUnitAbbreviation, measuringUnitId));
                                        });
                                } else {
                                    // No measuring unit ID, use base quantity
                                    console.warn('Item', idx, '- No measuring unit ID, using base quantity');
                                    resolve(createMappedItem(item, baseUnitQuantity, baseUnitQuantity, measuringUnitAbbreviation, null));
                                }
                            });
                    });

                    processPromises.push(promise);
                });

                // Wait for all conversions to complete
                Promise.all(processPromises).then(function(processedItems) {
                    console.log('All items processed. Count:', processedItems.length);
                    console.log('Processed items:', processedItems);

                    // Remove duplicates based on productId and productRangeId combination
                    var uniqueItems = [];
                    var seenKeys = new Set();

                    processedItems.forEach(function(item) {
                        var key = (item.productId || 0) + '_' + (item.productRangeId || 0);
                        if (!seenKeys.has(key)) {
                            seenKeys.add(key);
                            uniqueItems.push(item);
                        } else {
                            console.warn('Duplicate item found and removed:', item);
                        }
                    });

                    console.log('Unique items count:', uniqueItems.length);
                    console.log('Original count:', processedItems.length);

                    // Clear and set billDetails to prevent duplicates
                    billDetails = [];
                    billDetails = uniqueItems;
                    console.log('Mapped billDetails:', billDetails);
                    console.log('Final billDetails length:', billDetails.length);

                    // Update the bill details table
                    updateBillDetailsTable();
                    calculateTotals();

                    // Reset flag
                    isPopulatingEditForm = false;
                }).catch(function(error) {
                    console.error('Error processing bill details:', error);
                    isPopulatingEditForm = false;
                });
            } else {
                console.warn('No bill details data found or data is empty', {
                    billDetailsData: billDetailsData,
                    isArray: Array.isArray(billDetailsData),
                    length: billDetailsData ? billDetailsData.length : 'undefined'
                });
                // Reset flag even if no data
                isPopulatingEditForm = false;
            }

            // Helper function to create mapped item
            function createMappedItem(item, displayQuantity, baseUnitQuantity, measuringUnitAbbreviation, measuringUnitId) {
                // Ensure measuringUnitAbbreviation is not empty - use 'N/A' as fallback, not ProductSize (which is a range string)
                var finalAbbreviation = measuringUnitAbbreviation && measuringUnitAbbreviation.trim() !== '' ? measuringUnitAbbreviation : 'N/A';
                return {
                    productId: item.ProductId || item.productId || 0,
                    productRangeId: item.ProductRangeId || item.productRangeId || 0,
                    productCode: item.ProductCode || item.productCode || '',
                    productName: item.ProductName || item.productName || '',
                    productSize: item.ProductSize || item.productSize || '',
                    measuringUnitAbbreviation: finalAbbreviation,
                    measuringUnitId: measuringUnitId,
                    unitPrice: item.UnitPrice || item.unitPrice || 0,
                    purchasePrice: item.PurchasePrice || item.purchasePrice || 0,
                    quantity: displayQuantity, // Display quantity (converted)
                    baseUnitQuantity: baseUnitQuantity, // Base unit quantity (for saving)
                    salePrice: item.SalePrice || item.salePrice || 0,
                    lineDiscountAmount: item.LineDiscountAmount || item.lineDiscountAmount || 0,
                    payableAmount: item.PayableAmount || item.payableAmount || 0
                };
            }

            console.log('Edit form populated successfully');
        }

    </script>
}
